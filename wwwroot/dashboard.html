<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bankweave - Financial Dashboard</title>
    <meta name="version" content="2.0-rules-update">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #0f2744 50%, #1a3a52 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 50%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card h3 {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            position: relative;
        }

        .stat-card .value.positive {
            color: #10b981;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .stat-card .value.negative {
            color: #ef4444;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 20px;
            color: #ffffff;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-height: 44px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .account-list {
            display: grid;
            gap: 15px;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .account-item:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .account-info h3 {
            font-size: 16px;
            color: #ffffff;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .account-info p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
        }

        .account-balance {
            text-align: right;
        }

        .account-balance .amount {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
        }

        .account-balance .currency {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 3px;
        }

        .account-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .account-actions button {
            padding: 8px 15px;
            font-size: 12px;
        }

        .transaction-list {
            display: grid;
            gap: 10px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 4px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .transaction-item.income {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .transaction-item.expense {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .transaction-info h4 {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .transaction-info p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .category-badge {
            display: inline-block;
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 8px;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-amount .amount {
            font-size: 18px;
            font-weight: 600;
        }

        .transaction-amount .amount.positive {
            color: #10b981;
        }

        .transaction-amount .amount.negative {
            color: #ef4444;
        }

        .transaction-amount .date {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #ffffff;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .modal-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            min-height: 44px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }

        #balanceHistoryChart {
            margin-bottom: 20px;
        }

        .balance-chart {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 250px;
            padding: 10px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            gap: 5px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #06b6d4 0%, #14b8a6 100%);
            border-radius: 8px 8px 0 0;
            position: relative;
            min-height: 5px;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: scaleY(1.02);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #ffffff;
            white-space: nowrap;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .history-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .balance-change {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .balance-change.positive {
            color: #10b981;
        }

        .balance-change.negative {
            color: #ef4444;
        }

        .period-selector {
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .period-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        .period-btn.active {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .recurring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .recurring-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .recurring-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
            }

            .header {
                padding: 15px 20px;
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 13px;
                margin-top: 5px;
            }

            .section {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-card h3 {
                font-size: 13px;
            }

            .stat-card .value {
                font-size: 26px;
            }

            /* Tabs mobile optimization - horizontal scroll */
            .tabs {
                padding: 10px 10px 0 10px;
                gap: 5px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                margin-bottom: 15px;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab-btn {
                padding: 10px 18px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
                min-width: fit-content;
            }

            /* Account items */
            .account-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                gap: 12px;
            }

            .account-info {
                width: 100%;
            }

            .account-info h3 {
                font-size: 16px;
            }

            .account-info p {
                font-size: 12px;
            }

            .account-balance {
                margin-top: 12px;
                text-align: left;
            }

            .account-balance .balance {
                font-size: 22px;
            }

            .account-actions {
                width: 100%;
                margin-top: 12px;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .account-actions button {
                flex: 1 1 calc(50% - 4px);
                min-width: 120px;
                padding: 10px;
                font-size: 12px;
                min-height: 44px; /* Touch target size */
            }

            /* Section headers */
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                margin-bottom: 15px;
            }

            .section-header h2 {
                font-size: 18px;
            }

            .section-header > div {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* Period selectors */
            .period-selector {
                width: 100%;
                display: flex;
                gap: 5px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .period-selector::-webkit-scrollbar {
                display: none;
            }

            .period-btn {
                padding: 8px 14px;
                font-size: 12px;
                white-space: nowrap;
                flex-shrink: 0;
                min-height: 44px; /* Touch target */
            }

            /* Category grid */
            .category-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Transactions */
            .transaction-item {
                padding: 15px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .transaction-info {
                width: 100%;
            }

            .transaction-info h4 {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .transaction-info p {
                font-size: 12px;
                line-height: 1.5;
            }

            .transaction-amount {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            .transaction-amount .amount {
                font-size: 18px;
            }

            .transaction-amount .date {
                font-size: 11px;
                color: #999;
            }

            /* Badge styles */
            .badge {
                font-size: 11px;
                padding: 4px 8px;
                display: inline-block;
            }

            /* Modals - full screen on mobile */
            .modal-content {
                width: 95%;
                max-width: 95vw;
                max-height: 90vh;
                padding: 20px 15px;
                margin: 20px auto;
                overflow-y: auto;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .modal-header p {
                font-size: 13px;
            }

            /* Form elements */
            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 14px;
                padding: 12px;
                min-height: 44px; /* Touch target */
            }

            /* Buttons */
            .btn {
                padding: 12px 16px;
                font-size: 14px;
                min-height: 44px; /* Touch target */
                width: 100%;
            }

            .btn-secondary {
                font-size: 13px;
                min-height: 44px;
            }

            /* Charts */
            .chart-bars {
                gap: 3px;
            }

            .chart-bar-label {
                font-size: 9px;
            }

            .chart-bar-value {
                font-size: 10px;
            }

            canvas {
                max-height: 250px !important;
            }

            /* Tables - horizontal scroll */
            .history-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }

            .history-table th,
            .history-table td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            /* Search and filters */
            #transactionSearch {
                width: 100% !important;
                margin-bottom: 10px;
                font-size: 14px;
                padding: 12px;
                min-height: 44px;
            }

            #transactionFilter,
            #categoryFilter {
                width: 100%;
                margin-bottom: 10px;
                font-size: 14px;
                padding: 12px;
                min-height: 44px;
            }

            /* Recurring transactions */
            .recurring-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .recurring-section h3 {
                font-size: 16px;
            }

            .recurring-item {
                padding: 12px;
            }

            /* Rules tab */
            #rulesList > div {
                padding: 15px 12px;
            }

            #rulesList button {
                padding: 8px 12px;
                font-size: 12px;
                min-height: 44px;
            }

            /* Empty states */
            .empty-state {
                padding: 40px 20px;
            }

            .empty-state h3 {
                font-size: 18px;
            }

            .empty-state p {
                font-size: 14px;
            }

            /* Category list items */
            .category-item {
                padding: 12px;
            }

            .category-item h4 {
                font-size: 14px;
            }

            .category-item p {
                font-size: 12px;
            }
        }

        /* Extra small devices (phones in portrait, 480px and below) */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 12px 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 12px;
            }

            .section {
                padding: 15px 12px;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h3 {
                font-size: 12px;
            }

            .stat-card .value {
                font-size: 22px;
            }

            .tab-btn {
                padding: 8px 14px;
                font-size: 12px;
            }

            .period-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* Stack account buttons vertically on very small screens */
            .account-actions button {
                flex: 1 1 100%;
                min-width: unset;
            }

            .transaction-amount .amount {
                font-size: 16px;
            }

            .modal-content {
                padding: 15px 12px;
                width: 98%;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }

            canvas {
                max-height: 200px !important;
            }

            /* Smaller text for very small screens */
            .transaction-info h4 {
                font-size: 13px;
            }

            .transaction-info p {
                font-size: 11px;
            }

            .badge {
                font-size: 10px;
                padding: 3px 6px;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background: #10b981; }
            100% { transform: scale(1); }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px 0 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            color: #ffffff;
            border-bottom-color: #06b6d4;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.2);
            color: #14b8a6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        input, textarea {
            color-scheme: dark;
        }
        
        select {
            color-scheme: light;
        }
        
        .category-select {
            color-scheme: light !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="display: flex; align-items: center; gap: 12px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" style="width: 36px; height: 36px;">
                            <defs>
                                <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#14b8a6;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect width="100" height="100" rx="20" fill="url(#logoGrad)"/>
                            <path d="M30 40 L30 70 L45 70 L45 50 L55 50 L55 70 L70 70 L70 40 L50 25 Z" fill="white" opacity="0.9"/>
                            <circle cx="50" cy="60" r="8" fill="white"/>
                            <text x="50" y="66" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="url(#logoGrad)" text-anchor="middle">‚Ç¨</text>
                        </svg>
                        <span>Bankweave</span>
                    </h1>
                    <p>Your personal financial dashboard</p>
                </div>
                <div class="user-menu">
                    <div class="user-info" id="userInfo">
                        <span id="userName"></span>
                    </div>
                    <a href="/admin.html" id="adminLink" class="logout-btn" title="Admin Panel" style="display: none; text-decoration: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        Admin
                    </a>
                    <a href="/settings.html" class="logout-btn" title="Settings" style="text-decoration: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
                            <path d="M4.93 4.93l4.24 4.24m5.66 5.66l4.24 4.24M4.93 19.07l4.24-4.24m5.66-5.66l4.24-4.24"></path>
                        </svg>
                    </a>
                    <button class="logout-btn" onclick="Auth.logout()" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Balance</h3>
                <div class="value" id="totalBalance">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <h3>Income (30 days)</h3>
                <div class="value positive" id="income30">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <h3>Expenses (30 days)</h3>
                <div class="value negative" id="expenses30">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <h3>Essential Expenses (30d)</h3>
                <div class="value negative" id="essentialExpenses30">‚Ç¨0.00</div>
            </div>
            <div class="stat-card">
                <h3>Net (30 days)</h3>
                <div class="value" id="net30">‚Ç¨0.00</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('accounts')">üè¶ Accounts</button>
            <button class="tab-btn" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab-btn" onclick="switchTab('transactions')">üí∏ Transactions</button>
            <button class="tab-btn" onclick="switchTab('rules')">‚öôÔ∏è Rules</button>
            <button class="tab-btn" onclick="window.location.href='/scenarios.html'">üéØ What-If Scenarios</button>
        </div>

        <div id="accounts-tab" class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <h2>Connected Accounts</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="openManualAccountModal()">‚ûï Add Manual Account</button>
                    <button class="btn btn-secondary" onclick="openCsvModal()">üìÇ Import CSV</button>
                    <button class="btn btn-secondary" onclick="removeDuplicateTransactions()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">üóëÔ∏è Remove Duplicates</button>
                </div>
            </div>
            <div id="accountsList"></div>
        </div>
        </div>

        <div id="overview-tab" class="tab-content">
            <!-- Global Custom Date Range Selector -->
            <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="margin: 0 0 5px 0; color: white; font-size: 18px;">üìÖ Custom Date Range</h3>
                        <p style="margin: 0; color: rgba(255, 255, 255, 0.8); font-size: 13px;">Select dates to filter all sections at once</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="date" id="global-start-date" style="padding: 8px 12px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">
                        <span style="color: white; font-weight: 500;">to</span>
                        <input type="date" id="global-end-date" style="padding: 8px 12px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px; font-size: 14px; background: white; color: #1e293b; font-weight: 500; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">
                        <button class="btn" onclick="applyGlobalCustomRange()" style="padding: 8px 20px; font-size: 14px; background: white; color: #667eea; font-weight: 600;">Apply to All</button>
                        <button class="btn btn-secondary" onclick="clearGlobalCustomRange()" style="padding: 8px 20px; font-size: 14px;">Clear</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üí∞ Spending by Category</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="period-selector">
                            <button class="period-btn active" data-days="30" onclick="changeCategoryPeriod(30)">30 Days</button>
                            <button class="period-btn" data-days="90" onclick="changeCategoryPeriod(90)">90 Days</button>
                            <button class="period-btn" data-days="180" onclick="changeCategoryPeriod(180)">6 Months</button>
                            <button class="period-btn" data-days="365" onclick="changeCategoryPeriod(365)">1 Year</button>
                        </div>
                    </div>
                </div>
                <div class="category-grid">
                    <div>
                        <canvas id="categoryPieChart" width="400" height="400"></canvas>
                    </div>
                    <div id="categoryBreakdown"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üíµ Income by Category</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="period-selector">
                            <button class="period-btn active" data-income-days="30" onclick="changeIncomeCategoryPeriod(30)">30 Days</button>
                            <button class="period-btn" data-income-days="90" onclick="changeIncomeCategoryPeriod(90)">90 Days</button>
                            <button class="period-btn" data-income-days="180" onclick="changeIncomeCategoryPeriod(180)">6 Months</button>
                            <button class="period-btn" data-income-days="365" onclick="changeIncomeCategoryPeriod(365)">1 Year</button>
                        </div>
                    </div>
                </div>
                <div class="category-grid">
                    <div>
                        <canvas id="incomeCategoryPieChart" width="400" height="400"></canvas>
                    </div>
                    <div id="incomeCategoryBreakdown"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 onclick="viewEssentialExpenseTransactions()" style="cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='#f59e0b'" onmouseout="this.style.color=''" title="Click to view all essential expense transactions">üéØ Essential Expenses</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="period-selector">
                            <button class="period-btn active" data-essential-days="30" onclick="changeEssentialExpensesPeriod(30)">30 Days</button>
                            <button class="period-btn" data-essential-days="90" onclick="changeEssentialExpensesPeriod(90)">90 Days</button>
                            <button class="period-btn" data-essential-days="180" onclick="changeEssentialExpensesPeriod(180)">6 Months</button>
                            <button class="period-btn" data-essential-days="365" onclick="changeEssentialExpensesPeriod(365)">1 Year</button>
                        </div>
                    </div>
                </div>
                <div id="essentialExpensesSection"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üîÑ Recurring Transactions</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="period-selector">
                            <button class="period-btn active" data-months="6" onclick="changeRecurringPeriod(6)">6 Months</button>
                            <button class="period-btn" data-months="12" onclick="changeRecurringPeriod(12)">12 Months</button>
                        </div>
                        <button class="btn" onclick="loadRecurringTransactions(currentRecurringMonths)" title="Refresh recurring transactions analysis">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="recurringTransactions"></div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>üìà Balance History</h2>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div class="period-selector">
                        <button class="period-btn active" data-months="1" onclick="changeBalanceHistoryPeriod(1)">1M</button>
                        <button class="period-btn" data-months="3" onclick="changeBalanceHistoryPeriod(3)">3M</button>
                        <button class="period-btn" data-months="6" onclick="changeBalanceHistoryPeriod(6)">6M</button>
                        <button class="period-btn" data-months="12" onclick="changeBalanceHistoryPeriod(12)">1Y</button>
                        <button class="period-btn" data-months="999" onclick="changeBalanceHistoryPeriod(999)">All</button>
                    </div>
                    <button class="btn" onclick="createBalanceSnapshot()">üì∏ Record Snapshot</button>
                </div>
            </div>
            <div id="balanceHistoryChart"></div>
            <div id="balanceHistoryTable"></div>
        </div>
        </div>

        <div id="transactions-tab" class="tab-content">
            <div class="section">
            <div class="section-header">
                <h2>Recent Transactions</h2>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="transactionSearch" placeholder="üîç Search transactions..." 
                           onkeyup="searchTransactions(this.value)" 
                           style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 250px; font-size: 14px;">
                    <div class="period-selector">
                        <button class="period-btn active" data-filter="all" onclick="changeTransactionFilter('all')">All</button>
                        <button class="period-btn" data-filter="expenses" onclick="changeTransactionFilter('expenses')">Expenses</button>
                        <button class="period-btn" data-filter="income" onclick="changeTransactionFilter('income')">Income</button>
                    </div>
                    <select id="categoryFilter" onchange="changeTransactionCategoryFilter(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn btn-secondary" onclick="recategorizeAllTransactions()">üè∑Ô∏è Auto-Categorize All</button>
                </div>
            </div>
            <div id="transactionsList"></div>
        </div>
        </div>

        <div id="rules-tab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>‚öôÔ∏è Categorization Rules</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="openAddRuleModal()">‚ûï Add Rule</button>
                        <button class="btn btn-secondary" onclick="applyRulesToExisting()">üîÑ Apply to Existing</button>
                    </div>
                </div>
                <p style="color: rgba(255, 255, 255, 0.6); margin-bottom: 20px;">
                    Create rules to automatically categorize transactions based on their description. 
                    For example: if description contains "apple" ‚Üí categorize as "Bills"
                </p>
                <div id="rulesList"></div>
            </div>
        </div>
    </div>

    <!-- Transactions Modal -->
    <div class="modal" id="transactionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="transactionsModalTitle">Transactions</h2>
            </div>
            <div id="modalTransactionsList" class="transaction-list"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTransactionsModal()" style="width: 100%;">Close</button>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div class="modal" id="csvModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import CSV Transactions</h2>
                <p>Upload transaction history from Trading 212, Trade Republic, Raisin, or other banks</p>
            </div>
            <div class="form-group">
                <label for="providerSelect">Provider</label>
                <select id="providerSelect" onchange="updateAccountOptions()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; color: #1f2937;">
                    <option value="ptsb">PTSB (Permanent TSB)</option>
                    <option value="trading212">Trading 212</option>
                    <option value="traderepublic">Trade Republic</option>
                    <option value="raisin">Raisin</option>
                    <option value="revolut">Revolut</option>
                    <option value="generic">Other / Generic CSV</option>
                </select>
            </div>
            <div class="form-group">
                <label for="accountSelect">Account</label>
                <select id="accountSelect" onchange="handleAccountSelection()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; color: #1f2937;">
                    <option value="new">+ Create New Account</option>
                </select>
            </div>
            <div class="form-group" id="newAccountNameGroup" style="display: none;">
                <label for="accountNameInput">New Account Name</label>
                <input type="text" id="accountNameInput" placeholder="e.g., My Trading 212 Account" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label for="csvFileInput">CSV File</label>
                <input type="file" id="csvFileInput" accept=".csv" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeCsvModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="uploadCsv()" style="flex: 1;">Import</button>
            </div>
        </div>
    </div>

    <!-- Balance Confirmation Modal -->
    <div class="modal" id="balanceModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Account Balance</h2>
                <p id="balanceModalDescription">Please confirm or enter the balance for this account.</p>
            </div>
            <div class="form-group">
                <label for="balanceInput" id="balanceInputLabel">Balance (‚Ç¨)</label>
                <input type="number" id="balanceInput" step="0.01" placeholder="0.00" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <p id="balanceHint" style="font-size: 13px; color: #6b7280; margin-top: 10px;">
                Please enter the balance for this account.
            </p>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="skipBalance()" style="flex: 1;">Skip (Use ‚Ç¨0.00)</button>
                <button class="btn" onclick="confirmBalance()" style="flex: 1;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Rename Account Modal -->
    <div class="modal" id="renameModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rename Account</h2>
                <p>Enter a new name for this account</p>
            </div>
            <div class="form-group">
                <label for="renameInput">Account Name</label>
                <input type="text" id="renameInput" placeholder="e.g., My Savings Account" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeRenameModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="confirmRename()" style="flex: 1;">Rename</button>
            </div>
        </div>
    </div>

    <!-- Manual Account Modal -->
    <div class="modal" id="manualAccountModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Manual Account</h2>
                <p>Create an account without importing transactions</p>
            </div>
            <div class="form-group">
                <label for="manualProviderSelect">Provider</label>
                <select id="manualProviderSelect" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.05); color: white; cursor: pointer;">
                    <option value="traderepublic" style="background: #1a3a52; color: white;">Trade Republic</option>
                    <option value="ptsb" style="background: #1a3a52; color: white;">PTSB (Permanent TSB)</option>
                    <option value="trading212" style="background: #1a3a52; color: white;">Trading 212</option>
                    <option value="raisin" style="background: #1a3a52; color: white;">Raisin</option>
                    <option value="revolut" style="background: #1a3a52; color: white;">Revolut</option>
                    <option value="generic" style="background: #1a3a52; color: white;">Other / Generic</option>
                </select>
            </div>
            <div class="form-group">
                <label for="manualAccountNameInput">Account Name</label>
                <input type="text" id="manualAccountNameInput" placeholder="e.g., My Trade Republic Account" 
                       style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.05); color: white;">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="manualIsCreditCard" style="cursor: pointer; width: 18px; height: 18px; margin: 0; flex-shrink: 0;">
                    <span style="user-select: none;">This is a Credit Card</span>
                </label>
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Credit cards: Balance shows debt (negative), CSV imports won't update balance (manual only), but balance affects Total Balance.
                </p>
            </div>
            <div class="form-group">
                <label for="manualBalanceInput" id="manualBalanceLabel">Current Balance (‚Ç¨)</label>
                <input type="number" id="manualBalanceInput" step="0.01" placeholder="0.00" 
                       style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.05); color: white;">
                <p id="manualBalanceHint" style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    For credit cards, enter a negative amount (e.g., -500.00 if you owe ‚Ç¨500)
                </p>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeManualAccountModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="createManualAccount()" style="flex: 1;">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Update Balance Modal -->
    <div class="modal" id="updateBalanceModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Account Balance</h2>
                <p>Manually update the current balance</p>
            </div>
            <div class="form-group">
                <label for="updateBalanceInput">New Balance (‚Ç¨)</label>
                <input type="number" id="updateBalanceInput" step="0.01" placeholder="0.00" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeUpdateBalanceModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="confirmUpdateBalance()" style="flex: 1;">Update</button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal" id="addTransactionModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Manual Transaction</h2>
                <p id="addTransactionAccountName">Add a transaction to this account</p>
            </div>
            <div class="form-group">
                <label for="transactionDate">Date</label>
                <input type="date" id="transactionDate" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label for="transactionDescription">Description</label>
                <input type="text" id="transactionDescription" placeholder="e.g., Grocery shopping" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label for="transactionAmount">Amount (‚Ç¨)</label>
                <input type="number" id="transactionAmount" step="0.01" placeholder="0.00" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Use negative for expenses (e.g., -50.00), positive for income</p>
            </div>
            <div class="form-group">
                <label for="transactionCategory">Category</label>
                <select id="transactionCategory" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1f2937; background: white;">
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                    <option value="Transfer">Transfer</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeAddTransactionModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="confirmAddTransaction()" style="flex: 1;">Add Transaction</button>
            </div>
        </div>
    </div>

    <!-- CSV Sync Modal -->
    <div class="modal" id="syncCsvModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sync Balance from CSV</h2>
                <p id="syncCsvAccountName">Upload an updated CSV statement to sync balance</p>
            </div>
            <div class="form-group">
                <label for="syncCsvFileInput">CSV File</label>
                <input type="file" id="syncCsvFileInput" accept=".csv" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Select the latest CSV statement from your bank
                </p>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeSyncCsvModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="confirmSyncCsv()" style="flex: 1;">Upload & Sync</button>
            </div>
        </div>
    </div>

    <!-- Trading 212 API Key Modal -->
    <div class="modal" id="apiKeyModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Trading 212 API Credentials</h2>
                <p id="apiKeyAccountName">Enter your Trading 212 API credentials</p>
            </div>
            <div class="form-group">
                <label for="apiKeyInput">API Key</label>
                <input type="text" id="apiKeyInput" placeholder="Your API Key" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label for="apiSecretInput">API Secret</label>
                <input type="password" id="apiSecretInput" placeholder="Your API Secret" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                Get your credentials from Trading 212 ‚Üí Settings ‚Üí API (Beta)<br>
                Enter both the API Key and API Secret separately
            </p>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeApiKeyModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="confirmSetApiKey()" style="flex: 1;">Save & Sync</button>
            </div>
        </div>
    </div>

    <!-- Trading 212 CSV Mapping Modal -->
    <div class="modal" id="trading212CsvMappingModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÅ Upload Trading 212 CSV for Mapping</h2>
                <p id="trading212MappingAccountName">Upload your Trading 212 CSV statement to map transactions with API data</p>
            </div>
            <div class="form-group">
                <label for="trading212MappingCsvFile">CSV File</label>
                <input type="file" id="trading212MappingCsvFile" accept=".csv" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    üìÑ Download your CSV statement from Trading 212 app ‚Üí History ‚Üí Export<br>
                    üîó This will import transactions and enable mapping with API data<br>
                    ‚ú® Transactions will be automatically linked to avoid duplicates
                </p>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeTrading212CsvMappingModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="confirmTrading212CsvMapping()" style="flex: 1; background: linear-gradient(135deg, #14b8a6 0%, #0891b2 100%);">Upload & Map</button>
            </div>
        </div>
    </div>

    <!-- Category Transactions Modal -->
    <div class="modal" id="categoryTransactionsModal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="categoryTransactionsTitle">Transactions</h2>
                <button onclick="closeCategoryTransactionsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: rgba(255, 255, 255, 0.6); transition: color 0.3s;" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='rgba(255, 255, 255, 0.6)'">√ó</button>
            </div>
            <div id="categoryTransactionsList" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Categorization Rule Modal -->
    <div class="modal" id="ruleModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="ruleModalTitle">Add Categorization Rule</h2>
                <p>Create a rule to automatically categorize transactions based on their description</p>
            </div>
            <input type="hidden" id="ruleId">
            <div class="form-group">
                <label for="rulePattern">Pattern (text to match)</label>
                <input type="text" id="rulePattern" placeholder="e.g., apple, netflix, tesco" 
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Enter a keyword or phrase to look for in transaction descriptions
                </p>
            </div>
            <div class="form-group">
                <label for="ruleCategory">Category</label>
                <select id="ruleCategory" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1f2937; background: white;">
                    <option value="Balance Payment">Balance Payment</option>
                    <option value="Banking Fees">Banking Fees</option>
                    <option value="Bills">Bills</option>
                    <option value="Car Leasing">Car Leasing</option>
                    <option value="Cash Withdrawal">Cash Withdrawal</option>
                    <option value="Cashback">Cashback</option>
                    <option value="Charity">Charity</option>
                    <option value="Child Benefits">Child Benefits</option>
                    <option value="Childminder">Childminder</option>
                    <option value="Clothing">Clothing</option>
                    <option value="Credit Card Repayment">Credit Card Repayment</option>
                    <option value="Education">Education</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Groceries">Groceries</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Hello Fresh">Hello Fresh</option>
                    <option value="Home & Garden">Home & Garden</option>
                    <option value="Income">Income</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Interests">Interests</option>
                    <option value="Investments">Investments</option>
                    <option value="Large Expense">Large Expense</option>
                    <option value="Mortgage">Mortgage</option>
                    <option value="Other">Other</option>
                    <option value="Restaurants & Dining">Restaurants & Dining</option>
                    <option value="Salary">Salary</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Transfer In">Transfer In</option>
                    <option value="Transfers">Transfers</option>
                    <option value="Transport">Transport</option>
                    <option value="Travel">Travel</option>
                    <option value="Utilities">Utilities</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rulePriority">Priority (higher = checked first)</label>
                <input type="number" id="rulePriority" value="0" min="0" max="100"
                       style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Rules with higher priority are checked first. Default is 0.
                </p>
            </div>
            <div class="form-group">
                <label for="ruleTransactionType">Transaction Type</label>
                <select id="ruleTransactionType" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1f2937; background: white;">
                    <option value="Any">Any (both positive and negative)</option>
                    <option value="Positive">Positive only (income)</option>
                    <option value="Negative">Negative only (expenses)</option>
                </select>
                <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    Filter by transaction type to distinguish between similar names with different signs.
                </p>
            </div>
            <div class="form-group" style="display: flex; gap: 20px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="ruleIsRegex" style="cursor: pointer;">
                    <span>Use Regex (advanced)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="ruleCaseSensitive" style="cursor: pointer;">
                    <span>Case-sensitive</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="ruleMarkEssential" style="cursor: pointer;">
                    <span>üéØ Mark as Essential Expense</span>
                </label>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeRuleModal()" style="flex: 1;">Cancel</button>
                <button class="btn" onclick="saveRule()" style="flex: 1;">Save Rule</button>
            </div>
        </div>
    </div>

    <!-- Bulk Essential Toggle Modal -->
    <div class="modal" id="bulkEssentialModal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Mark as Essential Expense</h2>
                <p>Choose how to apply this change</p>
            </div>
            <input type="hidden" id="bulkTransactionId">
            <input type="hidden" id="bulkTransactionDescription">
            <input type="hidden" id="bulkCurrentValue">
            <div style="margin: 20px 0;">
                <button class="btn btn-secondary" onclick="bulkUpdateEssential('single')" 
                        style="width: 100%; padding: 16px; margin-bottom: 15px; justify-content: flex-start; text-align: left;">
                    <div>
                        <strong>This transaction only</strong>
                        <p style="font-size: 12px; color: rgba(255, 255, 255, 0.7); margin: 5px 0 0 0;">
                            Update only the selected transaction
                        </p>
                    </div>
                </button>
                <button class="btn" onclick="bulkUpdateEssential('similar')" 
                        style="width: 100%; padding: 16px; justify-content: flex-start; text-align: left; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <div>
                        <strong>All similar transactions</strong>
                        <p style="font-size: 12px; color: rgba(255, 255, 255, 0.9); margin: 5px 0 0 0;">
                            Update all transactions with the same description
                        </p>
                    </div>
                </button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeBulkEssentialModal()" style="width: 100%;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentAccountId = null;
        let pendingBalanceAccountId = null;
        let pendingApiKeyAccountId = null;
        let pendingSyncCsvAccountId = null;
        let pendingTrading212MappingAccountId = null;
        let pendingSyncCsvProvider = null;

        // Load overview stats
        async function loadOverview() {
            try {
                const response = await Auth.fetchWithAuth('/api/stats/overview');
                const data = await response.json();
                
                document.getElementById('totalBalance').textContent = formatCurrency(data.totalBalance);
                document.getElementById('income30').textContent = formatCurrency(data.income30Days);
                document.getElementById('expenses30').textContent = formatCurrency(data.expenses30Days);
                document.getElementById('essentialExpenses30').textContent = formatCurrency(data.essentialExpenses30Days);
                
                const net = data.net30Days;
                const netElement = document.getElementById('net30');
                netElement.textContent = formatCurrency(net);
                netElement.className = 'value ' + (net >= 0 ? 'positive' : 'negative');
            } catch (error) {
                console.error('Failed to load overview:', error);
            }
        }

        // Load accounts
        function getInstitutionColor(provider) {
            const providerLower = provider.toLowerCase();
            const colors = {
                'revolut': '#FFFFFF',
                'trading212': '#28a745',
                'ptsb': '#FF6B35',
                'permanent tsb': '#FF6B35',
                'raisin': '#0075EB',
                'trade republic': '#1a1a1a',
                'traderepublic': '#1a1a1a',
                'aib': '#1E3A8A',
                'boi': '#004C93',
                'bank of ireland': '#004C93',
                'n26': '#36DEBD',
                'monzo': '#E74C3C',
                'wise': '#37517E'
            };
            return colors[providerLower] || '#06b6d4';
        }

        function getInstitutionIcon(provider) {
            const providerLower = provider.toLowerCase();
            const firstLetter = provider.charAt(0).toUpperCase();
            
            // Map of provider to local logo files and brand colors
            const institutions = {
                'revolut': { logo: '/logos/revolut.png', color: '#FFFFFF' },
                'trading212': { logo: '/logos/trading212.png', color: '#28a745' },
                'ptsb': { logo: '/logos/ptsb.png', color: '#FF6B35' },
                'permanent tsb': { logo: '/logos/ptsb.png', color: '#FF6B35' },
                'raisin': { logo: '/logos/raisin.png', color: '#0075EB' },
                'trade republic': { logo: '/logos/traderepublic.png', color: '#1a1a1a' },
                'traderepublic': { logo: '/logos/traderepublic.png', color: '#1a1a1a' },
                'aib': { logo: '/logos/aib.png', color: '#1E3A8A' },
                'boi': { logo: '/logos/boi.png', color: '#004C93' },
                'bank of ireland': { logo: '/logos/boi.png', color: '#004C93' },
                'n26': { logo: '/logos/n26.png', color: '#36DEBD' },
                'monzo': { logo: '/logos/monzo.png', color: '#E74C3C' },
                'wise': { logo: '/logos/wise.png', color: '#37517E' }
            };
            
            const institution = institutions[providerLower];
            const brandColor = institution?.color || '#06b6d4';
            const logoUrl = institution?.logo;
            
            if (logoUrl) {
                return `<div style="width: 40px; height: 40px; border-radius: 8px; overflow: hidden; background: ${brandColor}; padding: 4px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px ${brandColor}40;">
                            <img src="${logoUrl}" alt="${provider}" style="width: 100%; height: 100%; object-fit: contain;" 
                                 onerror="this.parentElement.outerHTML='<div style=&quot;width: 40px; height: 40px; background: ${brandColor}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white; box-shadow: 0 2px 8px ${brandColor}40;&quot;>${firstLetter}</div>';">
                        </div>`;
            }
            
            // Fallback to letter avatar with brand color
            return `<div style="width: 40px; height: 40px; background: ${brandColor}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white; box-shadow: 0 2px 8px ${brandColor}40;">${firstLetter}</div>`;
        }

        async function loadAccounts() {
            try {
                const response = await Auth.fetchWithAuth('/api/accounts');
                const accounts = await response.json();
                
                const container = document.getElementById('accountsList');
                
                if (accounts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No accounts connected</h3>
                            <p>Connect your first bank account to get started</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = accounts.map(account => {
                    const brandColor = getInstitutionColor(account.provider);
                    return `
                    <div class="account-item" style="border-left: 4px solid ${brandColor}; box-shadow: 0 4px 16px ${brandColor}20;">
                        <div style="display: flex; gap: 15px; align-items: flex-start; width: 100%;">
                            <div style="flex-shrink: 0;">
                                ${getInstitutionIcon(account.provider)}
                            </div>
                            <div style="flex: 1;">
                                <div class="account-info">
                                    <h3>
                                        ${account.displayName}
                                        ${account.isCreditCard ? '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">CREDIT CARD</span>' : ''}
                                    </h3>
                                    <p>${account.iban || 'No IBAN'} ‚Ä¢ ${account.provider}</p>
                                <p style="font-size: 11px; color: rgba(255, 255, 255, 0.5); margin-top: 5px;">
                                    Last synced: ${account.lastSynced ? new Date(account.lastSynced).toLocaleString() : 'Never'}
                                </p>
                                ${account.isCreditCard ? '<p style="font-size: 11px; color: #ef4444; margin-top: 5px;">üí≥ Balance updated manually ‚Ä¢ Transactions for analytics only</p>' : ''}
                                <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; font-size: 13px; cursor: pointer;">
                                    <input type="checkbox" ${account.excludeFromTotal ? 'checked' : ''} 
                                           onchange="toggleExcludeFromTotal('${account.id}', this.checked)"
                                           style="cursor: pointer;">
                                    <span style="color: rgba(255, 255, 255, 0.6);">Exclude from Total Balance</span>
                                </label>
                            </div>
                            <div class="account-actions">
                                <button class="btn" onclick="viewTransactions('${account.id}', '${account.displayName}')">
                                    View Transactions
                                </button>
                                ${account.provider.toLowerCase() === 'trading212' ? `
                                    <button class="btn" onclick="syncTrading212('${account.id}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                        üîÑ Sync Balance
                                    </button>
                                    <button class="btn" onclick="openTrading212CsvMappingModal('${account.id}', '${account.displayName}')" style="background: linear-gradient(135deg, #14b8a6 0%, #0891b2 100%);">
                                        üìÅ Upload CSV for Mapping
                                    </button>
                                    <button class="btn btn-secondary" onclick="openApiKeyModal('${account.id}')" style="background: #f59e0b; color: white;">
                                        üîë Update API Key
                                    </button>
                                ` : `
                                    <button class="btn" onclick="openSyncCsvModal('${account.id}', '${account.provider}', '${account.displayName}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                        üîÑ Sync Balance
                                    </button>
                                `}
                                <button class="btn btn-secondary" onclick="openAddTransactionModal('${account.id}', '${account.displayName}')">
                                    Add Transaction
                                </button>
                                <button class="btn btn-secondary" onclick="openUpdateBalanceModal('${account.id}', ${account.balance})">
                                    Update Balance
                                </button>
                                <button class="btn btn-secondary" onclick="openRenameModal('${account.id}', '${account.displayName}')">
                                    Rename
                                </button>
                                <button class="btn btn-danger" onclick="deleteAccount('${account.id}')">
                                    Delete
                                </button>
                            </div>
                            </div>
                        </div>
                        <div class="account-balance">
                            <div class="amount">${formatCurrency(account.balance)}</div>
                            <div class="currency">${account.currency}</div>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Failed to load accounts:', error);
            }
        }

        // Load recent transactions across all accounts
        // Transaction filter state
        let currentTransactionFilter = 'all';
        let currentCategoryFilter = '';
        let allLoadedTransactions = [];

        async function loadRecentTransactions(filter = currentTransactionFilter) {
            try {
                const accountsResponse = await Auth.fetchWithAuth('/api/accounts');
                const accounts = await accountsResponse.json();
                
                if (accounts.length === 0) {
                    document.getElementById('transactionsList').innerHTML = `
                        <div class="empty-state">
                            <p>No transactions yet</p>
                        </div>
                    `;
                    return;
                }
                
                // Get transactions from all accounts
                allLoadedTransactions = [];
                for (const account of accounts) {
                    const response = await Auth.fetchWithAuth(`/api/accounts/${account.id}/transactions?pageSize=10000`);
                    const data = await response.json();
                    allLoadedTransactions = allLoadedTransactions.concat(data.transactions);
                }
                
                // Sort by date descending
                allLoadedTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Populate category filter dropdown
                populateCategoryFilter();
                
                // Apply filters
                applyTransactionFilters();
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        function populateCategoryFilter() {
            const categories = [...new Set(allLoadedTransactions
                .map(t => t.category)
                .filter(c => c && c !== 'Other')
            )].sort();
            
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === currentCategoryFilter) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function applyTransactionFilters() {
            // Filter out transfers from analytics
            let filteredTransactions = allLoadedTransactions.filter(t => 
                t.category !== 'Transfer' && 
                t.category !== 'Transfer In' && 
                t.category !== 'Transfers' &&
                t.category !== 'Balance Payment'
            );
            
            // Apply type filter (all/expenses/income)
            if (currentTransactionFilter === 'expenses') {
                filteredTransactions = filteredTransactions.filter(t => t.amount < 0);
            } else if (currentTransactionFilter === 'income') {
                filteredTransactions = filteredTransactions.filter(t => t.amount > 0);
            }
            
            // Apply category filter
            if (currentCategoryFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.category === currentCategoryFilter);
            }
            
            // Show most recent 50
            displayTransactions(filteredTransactions.slice(0, 50), 'transactionsList', currentTransactionFilter, currentCategoryFilter);
        }

        function changeTransactionFilter(filter) {
            currentTransactionFilter = filter;
            
            // Update button states
            document.querySelectorAll('#transactions-tab .period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            applyTransactionFilters();
        }

        function changeTransactionCategoryFilter(category) {
            currentCategoryFilter = category;
            applyTransactionFilters();
        }

        function searchTransactions(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            
            if (!term) {
                // If search is empty, just apply normal filters
                applyTransactionFilters();
                return;
            }

            // Filter out transfers from analytics
            let filteredTransactions = allLoadedTransactions.filter(t => 
                t.category !== 'Transfer' && 
                t.category !== 'Transfer In' && 
                t.category !== 'Transfers' &&
                t.category !== 'Balance Payment'
            );
            
            // Apply type filter (all/expenses/income)
            if (currentTransactionFilter === 'expenses') {
                filteredTransactions = filteredTransactions.filter(t => t.amount < 0);
            } else if (currentTransactionFilter === 'income') {
                filteredTransactions = filteredTransactions.filter(t => t.amount > 0);
            }
            
            // Apply category filter
            if (currentCategoryFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.category === currentCategoryFilter);
            }

            // Apply search filter
            filteredTransactions = filteredTransactions.filter(t => {
                const description = (t.description || '').toLowerCase();
                const category = (t.category || '').toLowerCase();
                const accountName = (t.accountName || '').toLowerCase();
                const amount = Math.abs(t.amount).toString();
                const date = new Date(t.date).toLocaleDateString().toLowerCase();
                
                return description.includes(term) || 
                       category.includes(term) || 
                       accountName.includes(term) ||
                       amount.includes(term) ||
                       date.includes(term);
            });
            
            // Show all matching results (up to 100)
            displayTransactions(filteredTransactions.slice(0, 100), 'transactionsList', currentTransactionFilter, currentCategoryFilter);
        }

        // Display transactions
        function displayTransactions(transactions, containerId, filter = 'all', categoryFilter = '') {
            const container = document.getElementById(containerId);
            
            if (transactions.length === 0) {
                let filterText = 'transactions';
                if (filter === 'expenses') filterText = 'expenses';
                else if (filter === 'income') filterText = 'income';
                if (categoryFilter) filterText += ` in category "${categoryFilter}"`;
                
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No ${filterText} found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = transactions.map(txn => {
                const isIncome = txn.amount > 0;
                const escapedCategory = (txn.category || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const categoryBadge = txn.category ? `<span class="category-badge" onclick="showCategoryDropdown('${txn.id}', '${escapedCategory}')" style="cursor: pointer; background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">${txn.category}</span>` : '';
                const accountBadge = txn.accountName ? `<span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">${txn.accountName}</span>` : '';
                const essentialBadge = !isIncome && txn.isEssentialExpense ? `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">üéØ Essential</span>` : '';
                const essentialToggle = !isIncome ? `<button onclick="toggleEssential('${txn.id}', ${txn.isEssentialExpense || false}, '${escapeHtml(txn.description || '').replace(/'/g, "\\'")}' )" style="background: ${txn.isEssentialExpense ? '#f59e0b' : '#374151'}; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin-left: 5px;" title="${txn.isEssentialExpense ? 'Remove from essential' : 'Mark as essential'}">${txn.isEssentialExpense ? 'üéØ' : '‚ûïüéØ'}</button>` : '';
                
                return `
                    <div class="transaction-item ${isIncome ? 'income' : 'expense'}" data-transaction-id="${txn.id}">
                        <div class="transaction-info">
                            <h4>${txn.description || 'No description'}</h4>
                            <p>
                                ${accountBadge}
                                <span id="category-badge-${txn.id}">${categoryBadge}</span>
                                <span id="category-dropdown-${txn.id}" style="display: none; margin-left: 5px;"></span>
                                ${essentialBadge}
                                ${essentialToggle}
                            </p>
                        </div>
                        <div class="transaction-amount">
                            <div class="amount ${isIncome ? 'positive' : 'negative'}">
                                ${isIncome ? '+' : ''}${formatCurrency(txn.amount)}
                            </div>
                            <div class="date">${new Date(txn.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show category dropdown when badge is clicked
        function showCategoryDropdown(transactionId, currentCategory) {
            const categories = [
                'Balance Payment',
                'Banking Fees',
                'Bills',
                'Car Leasing',
                'Cash Withdrawal',
                'Cashback',
                'Charity',
                'Child Benefits',
                'Childminder',
                'Clothing',
                'Credit Card Repayment',
                'Education',
                'Entertainment',
                'Groceries',
                'Healthcare',
                'Hello Fresh',
                'Home & Garden',
                'Income',
                'Insurance',
                'Interests',
                'Investments',
                'Large Expense',
                'Mortgage',
                'Other',
                'Restaurants & Dining',
                'Salary',
                'Shopping',
                'Transfer In',
                'Transfers',
                'Transport',
                'Travel',
                'Utilities'
            ];

            const badgeElement = document.getElementById(`category-badge-${transactionId}`);
            const dropdownElement = document.getElementById(`category-dropdown-${transactionId}`);
            
            // Hide badge, show dropdown
            badgeElement.style.display = 'none';
            dropdownElement.style.display = 'inline-block';
            
            const categoryOptions = categories.map(cat => 
                `<option value="${cat}" ${currentCategory === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
            
            dropdownElement.innerHTML = `
                <select id="select-${transactionId}" class="category-select" style="padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; cursor: pointer; color: #1f2937; background: white;">
                    ${categoryOptions}
                </select>
                <button onclick="showCategorySaveOptions('${transactionId}', '${currentCategory}')" style="margin-left: 4px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úì</button>
                <button onclick="cancelCategoryChange('${transactionId}', '${currentCategory}')" style="margin-left: 4px; padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úï</button>
            `;
        }

        // Show options for saving category change
        function showCategorySaveOptions(transactionId, oldCategory) {
            const selectElement = document.getElementById(`select-${transactionId}`);
            const newCategory = selectElement.value;
            
            if (newCategory === oldCategory) {
                cancelCategoryChange(transactionId, oldCategory);
                return;
            }

            // Show modal with options
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #333;">Update Category</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">How would you like to update the category to "${newCategory}"?</p>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="saveCategoryChange('${transactionId}', '${oldCategory}', 'single'); this.closest('[style*=fixed]').remove();" 
                                style="padding: 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Update this transaction only
                        </button>
                        <button onclick="saveCategoryChange('${transactionId}', '${oldCategory}', 'all'); this.closest('[style*=fixed]').remove();" 
                                style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Update all similar transactions
                        </button>
                        <button onclick="this.closest('[style*=fixed]').remove(); cancelCategoryChange('${transactionId}', '${oldCategory}');" 
                                style="padding: 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Save category change
        async function saveCategoryChange(transactionId, oldCategory, mode = 'single') {
            const selectElement = document.getElementById(`select-${transactionId}`);
            const newCategory = selectElement.value;
            
            if (newCategory === oldCategory) {
                cancelCategoryChange(transactionId, oldCategory);
                return;
            }
            
            if (mode === 'single') {
                await updateSingleTransactionCategory(transactionId, newCategory);
            } else {
                await updateTransactionCategory(transactionId, newCategory);
            }
        }

        // Cancel category change
        function cancelCategoryChange(transactionId, currentCategory) {
            const badgeElement = document.getElementById(`category-badge-${transactionId}`);
            const dropdownElement = document.getElementById(`category-dropdown-${transactionId}`);
            
            // Show badge, hide dropdown
            badgeElement.style.display = 'inline';
            dropdownElement.style.display = 'none';
            dropdownElement.innerHTML = '';
        }

        // Toggle essential expense
        async function toggleEssential(transactionId, currentValue, description) {
            // Store the transaction info and show the modal
            document.getElementById('bulkTransactionId').value = transactionId;
            document.getElementById('bulkTransactionDescription').value = description || '';
            document.getElementById('bulkCurrentValue').value = currentValue;
            
            const modal = document.getElementById('bulkEssentialModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeBulkEssentialModal() {
            const modal = document.getElementById('bulkEssentialModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function bulkUpdateEssential(mode) {
            const transactionId = document.getElementById('bulkTransactionId').value;
            const currentValue = document.getElementById('bulkCurrentValue').value === 'true';
            const description = document.getElementById('bulkTransactionDescription').value;
            
            closeBulkEssentialModal();
            
            try {
                if (mode === 'single') {
                    // Update single transaction
                    const response = await Auth.fetchWithAuth(`/api/accounts/transactions/${transactionId}/toggle-essential`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isEssential: !currentValue })
                    });
                    
                    if (response.ok) {
                        await loadRecentTransactions();
                        await loadOverview();
                        await loadEssentialExpenses();
                        if (window.bulkEssentialCallback) {
                            await window.bulkEssentialCallback();
                            window.bulkEssentialCallback = null;
                        }
                    } else {
                        alert('Failed to toggle essential expense');
                    }
                } else if (mode === 'similar') {
                    // Bulk update similar transactions
                    const response = await Auth.fetchWithAuth('/api/accounts/transactions/bulk-toggle-essential', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            description: description,
                            isEssential: !currentValue 
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        await loadRecentTransactions();
                        await loadOverview();
                        await loadEssentialExpenses();
                        if (window.bulkEssentialCallback) {
                            await window.bulkEssentialCallback();
                            window.bulkEssentialCallback = null;
                        }
                        alert(`Updated ${result.count} transaction(s) successfully!`);
                    } else {
                        alert('Failed to bulk update essential expenses');
                    }
                }
            } catch (error) {
                console.error('Failed to update essential expense:', error);
                alert('Failed to update essential expense');
            }
        }

        // Toggle essential expense in modal
        async function toggleEssentialInModal(transactionId, currentValue, description) {
            // Store the transaction info and show the modal
            document.getElementById('bulkTransactionId').value = transactionId;
            document.getElementById('bulkTransactionDescription').value = description || '';
            document.getElementById('bulkCurrentValue').value = currentValue;
            
            // Store callback to reload modal
            window.bulkEssentialCallback = async function() {
                // Reload the modal content
                const modal = document.getElementById('categoryTransactionsModal');
                const modalStyle = modal.style.display;
                
                if (modalStyle === 'block') {
                    // Category transactions modal is open, reload it
                    const title = document.getElementById('categoryTransactionsTitle').textContent;
                    
                    // Check if it's the essential expenses view
                    if (title === 'üéØ Essential Expense Transactions') {
                        await viewEssentialExpenseTransactions();
                    } else if (title.startsWith('üéØ ') && title.includes('- Essential Expenses')) {
                        // It's a category-filtered essential expenses view
                        const categoryName = title.replace('üéØ ', '').replace(' - Essential Expenses', '');
                        await viewEssentialExpensesByCategory(categoryName);
                    } else {
                        const categoryName = title.replace(' Transactions', '');
                        await viewCategoryTransactions(categoryName);
                    }
                }
                
                // Check if account transactions modal is open
                const accountModal = document.getElementById('transactionsModal');
                if (accountModal && accountModal.style.display === 'block') {
                    await viewTransactions(currentAccountId, document.getElementById('transactionsModalTitle').textContent.replace('Transactions - ', ''));
                }
            };
            
            const modal = document.getElementById('bulkEssentialModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        // View account transactions
        async function viewTransactions(accountId, accountName) {
            currentAccountId = accountId;
            document.getElementById('transactionsModalTitle').textContent = `Transactions - ${accountName}`;
            
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/${accountId}/transactions?pageSize=100`);
                const data = await response.json();
                displayTransactions(data.transactions, 'modalTransactionsList');
                document.getElementById('transactionsModal').classList.add('active');
            } catch (error) {
                console.error('Failed to load transactions:', error);
                alert('Failed to load transactions');
            }
        }

        function closeTransactionsModal() {
            document.getElementById('transactionsModal').classList.remove('active');
        }

        // CSV Import
        async function openCsvModal() {
            document.getElementById('csvModal').classList.add('active');
            // Show new account input by default
            document.getElementById('newAccountNameGroup').style.display = 'block';
            await updateAccountOptions();
        }

        function closeCsvModal() {
            document.getElementById('csvModal').classList.remove('active');
            document.getElementById('csvFileInput').value = '';
            document.getElementById('accountNameInput').value = '';
            document.getElementById('accountSelect').value = 'new';
            document.getElementById('newAccountNameGroup').style.display = 'none';
        }

        async function updateAccountOptions() {
            const provider = document.getElementById('providerSelect').value;
            const accountSelect = document.getElementById('accountSelect');
            
            // Keep the "Create New Account" option
            accountSelect.innerHTML = '<option value="new">+ Create New Account</option>';
            
            try {
                const response = await Auth.fetchWithAuth('/api/accounts');
                const accounts = await response.json();
                
                // Filter accounts by selected provider
                const providerAccounts = Array.isArray(accounts) 
                    ? accounts.filter(a => a.provider === provider)
                    : (accounts.provider === provider ? [accounts] : []);
                
                // Add existing accounts as options
                providerAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.displayName;
                    option.textContent = `${account.displayName} (‚Ç¨${account.balance.toFixed(2)})`;
                    accountSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load accounts:', error);
            }
            
            // Update input field visibility based on selection
            handleAccountSelection();
        }

        function handleAccountSelection() {
            const accountSelect = document.getElementById('accountSelect');
            const newAccountNameGroup = document.getElementById('newAccountNameGroup');
            
            if (accountSelect.value === 'new') {
                newAccountNameGroup.style.display = 'block';
            } else {
                newAccountNameGroup.style.display = 'none';
            }
        }

        function showBalanceModal(accountId, detectedBalance, hasBalanceColumn) {
            pendingBalanceAccountId = accountId;
            const modal = document.getElementById('balanceModal');
            const input = document.getElementById('balanceInput');
            const description = document.getElementById('balanceModalDescription');
            const label = document.getElementById('balanceInputLabel');
            const hint = document.getElementById('balanceHint');
            
            if (hasBalanceColumn && detectedBalance !== null) {
                // CSV has balance column (e.g., PTSB) - detected balance is the current balance
                input.value = detectedBalance.toFixed(2);
                label.textContent = 'Current Balance (‚Ç¨)';
                description.textContent = `A balance of ‚Ç¨${detectedBalance.toFixed(2)} was detected in your CSV. Please confirm or adjust:`;
                hint.textContent = 'This is the current balance shown in your CSV statement.';
            } else {
                // CSV doesn't have balance column (e.g., Trading 212, Trade Republic)
                input.value = '';
                label.textContent = 'Current Balance (‚Ç¨)';
                description.textContent = 'No balance was detected in the CSV. Please enter the current balance from your account:';
                hint.textContent = 'Enter the current balance showing in your account. This should match the balance after all imported transactions.';
            }
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            input.focus();
        }

        function closeBalanceModal() {
            const modal = document.getElementById('balanceModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            pendingBalanceAccountId = null;
        }

        async function skipBalance() {
            if (!pendingBalanceAccountId) return;
            
            try {
                await Auth.fetchWithAuth(`/api/csvimport/set-balance/${pendingBalanceAccountId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startingBalance: 0 })
                });
                
                closeBalanceModal();
                alert('Account created with balance of ‚Ç¨0.00');
                await loadData();
            } catch (error) {
                console.error('Failed to set balance:', error);
                alert('Failed to set balance');
            }
        }

        async function confirmBalance() {
            if (!pendingBalanceAccountId) return;
            
            const input = document.getElementById('balanceInput');
            const balance = parseFloat(input.value) || 0;
            
            try {
                const response = await Auth.fetchWithAuth(`/api/csvimport/set-balance/${pendingBalanceAccountId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startingBalance: balance })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeBalanceModal();
                    alert(`Success! Account balance set to ‚Ç¨${balance.toFixed(2)}`);
                    await loadData();
                } else {
                    alert(`Failed to set balance: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to set balance:', error);
                alert('Failed to set balance');
            }
        }

        // Rename account functionality
        let pendingRenameAccountId = null;

        function openRenameModal(accountId, currentName) {
            pendingRenameAccountId = accountId;
            document.getElementById('renameInput').value = currentName;
            const modal = document.getElementById('renameModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeRenameModal() {
            const modal = document.getElementById('renameModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            document.getElementById('renameInput').value = '';
            pendingRenameAccountId = null;
        }

        async function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            
            if (!newName) {
                alert('Please enter a new name');
                return;
            }
            
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/${pendingRenameAccountId}/rename`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeRenameModal();
                    await loadAccounts();
                    alert('Account renamed successfully');
                } else {
                    alert(`Failed to rename account: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error renaming account:', error);
                alert('Failed to rename account. Please try again.');
            }
        }

        // Manual account functionality
        function openManualAccountModal() {
            const modal = document.getElementById('manualAccountModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
        
        async function removeDuplicateTransactions() {
            if (!confirm('This will remove duplicate transactions from your database. This action cannot be undone. Continue?')) {
                return;
            }
            
            try {
                const response = await Auth.fetchWithAuth('/api/csvimport/remove-duplicates', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Successfully removed ${data.transactionsRemoved} duplicate transactions from ${data.duplicateGroupsFound} groups.`);
                    await loadData(); // Reload all data to reflect changes
                } else {
                    alert(`Failed to remove duplicates: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error removing duplicates:', error);
                alert('Failed to remove duplicates');
            }
        }

        function closeManualAccountModal() {
            const modal = document.getElementById('manualAccountModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            document.getElementById('manualProviderSelect').value = 'traderepublic';
            document.getElementById('manualAccountNameInput').value = '';
            document.getElementById('manualBalanceInput').value = '';
            document.getElementById('manualIsCreditCard').checked = false;
        }

        async function createManualAccount() {
            const provider = document.getElementById('manualProviderSelect').value;
            const accountName = document.getElementById('manualAccountNameInput').value.trim();
            const balance = parseFloat(document.getElementById('manualBalanceInput').value) || 0;
            const isCreditCard = document.getElementById('manualIsCreditCard').checked;

            if (!accountName) {
                alert('Please enter an account name');
                return;
            }

            try {
                // Create the account
                const response = await Auth.fetchWithAuth('/api/csvimport/manual-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, accountName, currentBalance: balance, isCreditCard })
                });

                const data = await response.json();

                if (response.ok) {
                    closeManualAccountModal();
                    await loadData();
                    const accountType = isCreditCard ? 'credit card' : 'account';
                    alert(`${accountType.charAt(0).toUpperCase() + accountType.slice(1)} created successfully with balance ‚Ç¨${balance.toFixed(2)}`);
                } else {
                    alert(`Failed to create account: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error creating manual account:', error);
                alert('Failed to create account. Please try again.');
            }
        }

        // Update balance functionality
        let pendingUpdateBalanceAccountId = null;

        function openUpdateBalanceModal(accountId, currentBalance) {
            pendingUpdateBalanceAccountId = accountId;
            document.getElementById('updateBalanceInput').value = currentBalance.toFixed(2);
            const modal = document.getElementById('updateBalanceModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeUpdateBalanceModal() {
            const modal = document.getElementById('updateBalanceModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            pendingUpdateBalanceAccountId = null;
        }

        async function confirmUpdateBalance() {
            const newBalance = parseFloat(document.getElementById('updateBalanceInput').value);

            if (isNaN(newBalance)) {
                alert('Please enter a valid balance');
                return;
            }

            try {
                const response = await Auth.fetchWithAuth(`/api/csvimport/set-balance/${pendingUpdateBalanceAccountId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startingBalance: newBalance })
                });

                const data = await response.json();

                if (response.ok) {
                    closeUpdateBalanceModal();
                    await loadData();
                    alert(`Balance updated to ‚Ç¨${newBalance.toFixed(2)}`);
                } else {
                    alert(`Failed to update balance: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating balance:', error);
                alert('Failed to update balance. Please try again.');
            }
        }

        // Add transaction functionality
        let pendingAddTransactionAccountId = null;

        function openAddTransactionModal(accountId, accountName) {
            pendingAddTransactionAccountId = accountId;
            document.getElementById('addTransactionAccountName').textContent = `Add a transaction to ${accountName}`;
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDescription').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionCategory').value = 'Expense';
            const modal = document.getElementById('addTransactionModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeAddTransactionModal() {
            const modal = document.getElementById('addTransactionModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            pendingAddTransactionAccountId = null;
        }

        async function confirmAddTransaction() {
            const date = document.getElementById('transactionDate').value;
            const description = document.getElementById('transactionDescription').value.trim();
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const category = document.getElementById('transactionCategory').value;

            if (!description) {
                alert('Please enter a description');
                return;
            }

            if (isNaN(amount)) {
                alert('Please enter a valid amount');
                return;
            }

            try {
                const response = await Auth.fetchWithAuth('/api/accounts/manual-transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId: pendingAddTransactionAccountId,
                        date,
                        description,
                        amount,
                        category
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    closeAddTransactionModal();
                    await loadData();
                    alert('Transaction added successfully');
                } else {
                    alert(`Failed to add transaction: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('Failed to add transaction. Please try again.');
            }
        }

        async function uploadCsv() {
            const provider = document.getElementById('providerSelect').value;
            const accountSelect = document.getElementById('accountSelect');
            const accountNameInput = document.getElementById('accountNameInput');
            const fileInput = document.getElementById('csvFileInput');
            
            // Get account name from dropdown or input field
            let accountName;
            if (accountSelect.value === 'new') {
                accountName = accountNameInput.value;
                if (!accountName.trim()) {
                    alert('Please enter an account name');
                    return;
                }
            } else {
                accountName = accountSelect.value;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a CSV file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('provider', provider);
            formData.append('accountName', accountName);
            
            try {
                const response = await Auth.fetchWithAuth('/api/csvimport/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeCsvModal();
                    
                    // Check if this is a new account that needs balance setup
                    if (data.isNewAccount) {
                        showBalanceModal(data.accountId, data.detectedBalance, data.hasBalanceColumn);
                    } else {
                        alert(`Success! Imported ${data.importedCount} transactions (${data.skippedCount} duplicates skipped). Balance: ‚Ç¨${data.currentBalance.toFixed(2)}`);
                        await loadData();
                    }
                } else {
                    alert(`Failed to import CSV: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to upload CSV:', error);
                alert('Failed to upload CSV');
            }
        }

        // Delete account
        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account? All transactions will be removed.')) {
                return;
            }
            
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/${accountId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadData();
                    alert('Account deleted successfully');
                } else {
                    alert('Failed to delete account');
                }
            } catch (error) {
                console.error('Failed to delete account:', error);
                alert('Failed to delete account');
            }
        }

        // Toggle exclude from total
        async function toggleExcludeFromTotal(accountId, excludeFromTotal) {
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/${accountId}/exclude-from-total`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ excludeFromTotal })
                });
                
                if (response.ok) {
                    await loadOverview();
                } else {
                    alert('Failed to update account');
                    await loadAccounts();
                }
            } catch (error) {
                console.error('Failed to update account:', error);
                alert('Failed to update account');
                await loadAccounts();
            }
        }

        // CSV Sync Modal functions
        function openSyncCsvModal(accountId, provider, accountName) {
            pendingSyncCsvAccountId = accountId;
            pendingSyncCsvProvider = provider;
            document.getElementById('syncCsvAccountName').textContent = `Upload CSV statement for ${accountName}`;
            document.getElementById('syncCsvFileInput').value = '';
            const modal = document.getElementById('syncCsvModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeSyncCsvModal() {
            const modal = document.getElementById('syncCsvModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('syncCsvFileInput').value = '';
            }, 300);
        }

        async function confirmSyncCsv() {
            const fileInput = document.getElementById('syncCsvFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('provider', pendingSyncCsvProvider);
                formData.append('accountId', pendingSyncCsvAccountId);

                const response = await Auth.fetchWithAuth('/api/csvimport/sync', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    closeSyncCsvModal();
                    await loadData();
                    
                    // Automatically record balance snapshot after sync
                    await Auth.fetchWithAuth('/api/stats/snapshot', { method: 'POST' });
                    await loadBalanceHistory();
                    
                    const duplicateMsg = data.skippedDuplicates > 0 ? ` (${data.skippedDuplicates} duplicates skipped)` : '';
                    alert(`Balance synced successfully!\n\nNew balance: ‚Ç¨${data.newBalance.toFixed(2)}\nTransactions imported: ${data.transactionsImported}${duplicateMsg}`);
                } else {
                    alert(`Sync failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error syncing CSV:', error);
                alert('Failed to sync. Please try again.');
            }
        }

        // Trading 212 API Key Modal functions
        function openApiKeyModal(accountId) {
            pendingApiKeyAccountId = accountId;
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('apiSecretInput').value = '';
            const modal = document.getElementById('apiKeyModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('apiSecretInput').value = '';
            }, 300);
        }

        async function confirmSetApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const apiSecret = document.getElementById('apiSecretInput').value.trim();

            if (!apiKey || !apiSecret) {
                alert('Please enter both API Key and API Secret');
                return;
            }

            // Combine in format API_KEY:API_SECRET for Basic Auth
            const combinedKey = `${apiKey}:${apiSecret}`;

            try {
                // Save API key
                const setKeyResponse = await Auth.fetchWithAuth(`/api/accounts/${pendingApiKeyAccountId}/set-api-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey: combinedKey })
                });

                if (!setKeyResponse.ok) {
                    const data = await setKeyResponse.json();
                    alert(`Failed to save API key: ${data.message || 'Unknown error'}`);
                    return;
                }

                // Close modal
                closeApiKeyModal();

                // Sync immediately
                await syncTrading212Internal(pendingApiKeyAccountId);

            } catch (error) {
                console.error('Error setting API key:', error);
                alert('Failed to set API key. Please try again.');
            }
        }

        async function syncTrading212(accountId) {
            await syncTrading212Internal(accountId);
        }

        async function syncTrading212Internal(accountId) {
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/${accountId}/sync-trading212`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    await loadData();
                    
                    // Automatically record balance snapshot after sync
                    await Auth.fetchWithAuth('/api/stats/snapshot', { method: 'POST' });
                    await loadBalanceHistory();
                    
                    const balanceMsg = `Balance: ${formatCurrency(data.balance)}\nLast synced: ${new Date(data.lastSynced).toLocaleString()}`;
                    const transactionMsg = data.transactionsImported > 0 || data.transactionsLinked > 0
                        ? `\n\nTransactions:\n‚Ä¢ ${data.transactionsImported} new imported (ready for CSV mapping)\n‚Ä¢ ${data.transactionsLinked} linked to existing CSV`
                        : '\n\nNo new transactions';
                    
                    alert(`‚úÖ Sync Complete!\n\n${balanceMsg}${transactionMsg}`);
                } else {
                    // API key not set, open modal
                    if (data.message.includes('API key not set')) {
                        if (confirm('API key not set. Would you like to set it now?')) {
                            openApiKeyModal(accountId);
                        }
                    } else {
                        alert(`Sync failed: ${data.message}`);
                    }
                }
            } catch (error) {
                console.error('Error syncing Trading212:', error);
                alert('Failed to sync balance. Please try again.');
            }
        }

        async function syncTrading212Transactions(accountId) {
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/${accountId}/sync-trading212-transactions`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    await loadData();
                    const message = data.linked > 0 
                        ? `Transactions synced!\n\nFetched: ${data.totalFetched}\nNew imported: ${data.imported}\nLinked to CSV: ${data.linked}`
                        : `Transactions synced!\n\nFetched: ${data.totalFetched}\nNew imported: ${data.imported}`;
                    alert(message);
                } else {
                    if (data.message.includes('API key not set')) {
                        if (confirm('API key not set. Would you like to set it now?')) {
                            openApiKeyModal(accountId);
                        }
                    } else {
                        alert(`Sync failed: ${data.message}`);
                    }
                }
            } catch (error) {
                console.error('Error syncing Trading212 transactions:', error);
                alert('Failed to sync transactions. Please try again.');
            }
        }

        // Trading 212 CSV Mapping Modal functions
        function openTrading212CsvMappingModal(accountId, accountName) {
            pendingTrading212MappingAccountId = accountId;
            document.getElementById('trading212MappingAccountName').textContent = `Upload CSV statement for ${accountName} to enable transaction mapping`;
            document.getElementById('trading212MappingCsvFile').value = '';
            const modal = document.getElementById('trading212CsvMappingModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeTrading212CsvMappingModal() {
            const modal = document.getElementById('trading212CsvMappingModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('trading212MappingCsvFile').value = '';
            }, 300);
        }

        async function confirmTrading212CsvMapping() {
            const fileInput = document.getElementById('trading212MappingCsvFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            try {
                // First, import the CSV to get the transactions with ExternalIds
                const formData = new FormData();
                formData.append('file', file);
                formData.append('provider', 'trading212');
                formData.append('accountId', pendingTrading212MappingAccountId);

                const importResponse = await Auth.fetchWithAuth('/api/csvimport/sync', {
                    method: 'POST',
                    body: formData
                });

                const importData = await importResponse.json();

                if (!importResponse.ok) {
                    alert(`CSV import failed: ${importData.error || 'Unknown error'}`);
                    return;
                }

                // Then sync with API to link transactions
                const syncResponse = await Auth.fetchWithAuth(`/api/accounts/${pendingTrading212MappingAccountId}/sync-trading212-transactions`, {
                    method: 'POST'
                });

                const syncData = await syncResponse.json();

                closeTrading212CsvMappingModal();
                await loadData();

                // Automatically record balance snapshot
                await Auth.fetchWithAuth('/api/stats/snapshot', { method: 'POST' });
                await loadBalanceHistory();

                if (syncResponse.ok) {
                    alert(`‚úÖ CSV Mapping Complete!\n\n` +
                          `üì• CSV Import:\n` +
                          `  ‚Ä¢ Imported: ${importData.transactionsImported} transactions\n` +
                          `  ‚Ä¢ New balance: ‚Ç¨${importData.newBalance.toFixed(2)}\n\n` +
                          `üîó API Sync & Mapping:\n` +
                          `  ‚Ä¢ API fetched: ${syncData.totalFetched} transactions\n` +
                          `  ‚Ä¢ Linked to CSV: ${syncData.linked}\n` +
                          `  ‚Ä¢ New from API: ${syncData.imported}\n\n` +
                          `Your transactions are now mapped and ready!`);
                } else {
                    alert(`CSV imported successfully (${importData.transactionsImported} transactions), but API sync failed.\n\n` +
                          `You can try syncing with the API later using the Sync Balance button.`);
                }
            } catch (error) {
                console.error('Error with Trading212 CSV mapping:', error);
                alert('Failed to process CSV mapping. Please try again.');
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-IE', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update transaction category
        // Update category
        async function updateSingleTransactionCategory(transactionId, category) {
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/transactions/${transactionId}/category/single`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category })
                });

                if (response.ok) {
                    // Update the badge immediately for visual feedback
                    const badge = document.querySelector(`[data-transaction-id="${transactionId}"] .category-badge`);
                    if (badge) {
                        badge.textContent = category;
                        badge.className = 'category-badge';
                        badge.style.animation = 'pulse 0.5s';
                        setTimeout(() => badge.style.animation = '', 500);
                    }
                    
                    alert(`‚úÖ Category updated to "${category}"`);
                    await loadData();
                } else {
                    alert('Failed to update category');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                alert('Failed to update category');
            }
        }

        async function updateTransactionCategory(transactionId, category) {
            try {
                const response = await Auth.fetchWithAuth(`/api/accounts/transactions/${transactionId}/category`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category })
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Update the badge immediately for visual feedback
                    const badge = document.querySelector(`[data-transaction-id="${transactionId}"] .category-badge`);
                    if (badge) {
                        badge.textContent = category;
                        badge.className = 'category-badge'; // Reset classes
                        
                        // Add a success animation
                        badge.style.animation = 'pulse 0.5s';
                        setTimeout(() => {
                            badge.style.animation = '';
                        }, 500);
                    }
                    
                    // Show success message with count
                    const message = result.updatedCount > 1 
                        ? `‚úÖ Category updated!\n\n${result.updatedCount} similar transactions were also updated to "${category}"`
                        : `‚úÖ Category updated to "${category}"`;
                    
                    alert(message);
                    
                    // Reload data to reflect all changes
                    await loadData();
                } else {
                    alert('Failed to update category');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                alert('Failed to update category');
            }
        }

        async function viewCategoryTransactions(category) {
            try {
                // Fetch all accounts to get all transactions
                const accountsResponse = await Auth.fetchWithAuth('/api/accounts');
                if (!accountsResponse.ok) {
                    throw new Error(`Failed to fetch accounts: ${accountsResponse.status}`);
                }
                const accounts = await accountsResponse.json();
                
                // Collect all transactions from all accounts
                let allTransactions = [];
                for (const account of accounts) {
                    const txResponse = await Auth.fetchWithAuth(`/api/accounts/${account.id}/transactions?pageSize=10000`);
                    if (!txResponse.ok) {
                        console.error(`Failed to fetch transactions for account ${account.id}: ${txResponse.status}`);
                        continue; // Skip this account but continue with others
                    }
                    const txData = await txResponse.json();
                    const transactions = txData.transactions || []; // Extract transactions array from response
                    
                    allTransactions = allTransactions.concat(transactions);
                }
                
                // Filter by category
                const filtered = allTransactions.filter(tx => tx.category === category);
                
                // Sort by date descending
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Display in modal
                const modal = document.getElementById('categoryTransactionsModal');
                const title = document.getElementById('categoryTransactionsTitle');
                const list = document.getElementById('categoryTransactionsList');
                
                title.textContent = `${category} Transactions`;
                
                if (filtered.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: rgba(255, 255, 255, 0.6); padding: 20px;">No transactions found</p>';
                } else {
                    list.innerHTML = filtered.map(tx => {
                        const isIncome = tx.amount > 0;
                        const escapedCategory = (tx.category || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const essentialBadge = !isIncome && tx.isEssentialExpense ? `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">üéØ Essential</span>` : '';
                        const essentialToggle = !isIncome ? `<button onclick="toggleEssentialInModal('${tx.id}', ${tx.isEssentialExpense || false}, '${escapeHtml(tx.description || '').replace(/'/g, "\\'")}' )" style="background: ${tx.isEssentialExpense ? '#f59e0b' : '#374151'}; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin-left: 5px;" title="${tx.isEssentialExpense ? 'Remove from essential' : 'Mark as essential'}">${tx.isEssentialExpense ? 'üéØ' : '‚ûïüéØ'}</button>` : '';
                        
                        return `
                            <div style="padding: 15px; margin-bottom: 10px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; transition: all 0.3s ease;" data-transaction-id="${tx.id}" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(147, 51, 234, 0.5)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.15)';">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <div>
                                        <strong style="color: #ffffff;">${tx.description || 'No description'}</strong>
                                        <span id="category-badge-modal-${tx.id}">
                                            <span class="category-badge" onclick="showCategoryDropdownModal('${tx.id}', '${escapedCategory}')" style="cursor: pointer; background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-left: 8px; font-weight: 500;">${tx.category}</span>
                                        </span>
                                        <span id="category-dropdown-modal-${tx.id}" style="display: none; margin-left: 8px;"></span>
                                        ${essentialBadge}
                                        ${essentialToggle}
                                    </div>
                                    <span style="font-weight: 600; font-size: 16px; color: ${tx.amount < 0 ? '#ef4444' : '#10b981'};">‚Ç¨${tx.amount.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                                    ${new Date(tx.date).toLocaleDateString()} ‚Ä¢ ${tx.accountName}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading category transactions:', error);
                alert('Failed to load transactions');
            }
        }

        // Show category dropdown in modal
        function showCategoryDropdownModal(transactionId, currentCategory) {
            const categories = [
                'Balance Payment',
                'Banking Fees',
                'Bills',
                'Car Leasing',
                'Cash Withdrawal',
                'Cashback',
                'Charity',
                'Child Benefits',
                'Childminder',
                'Clothing',
                'Credit Card Repayment',
                'Education',
                'Entertainment',
                'Groceries',
                'Healthcare',
                'Hello Fresh',
                'Home & Garden',
                'Income',
                'Insurance',
                'Interests',
                'Investments',
                'Large Expense',
                'Mortgage',
                'Other',
                'Restaurants & Dining',
                'Salary',
                'Shopping',
                'Transfer In',
                'Transfers',
                'Transport',
                'Travel',
                'Utilities'
            ];

            const badgeElement = document.getElementById(`category-badge-modal-${transactionId}`);
            const dropdownElement = document.getElementById(`category-dropdown-modal-${transactionId}`);
            
            // Hide badge, show dropdown
            badgeElement.style.display = 'none';
            dropdownElement.style.display = 'inline-block';
            
            const categoryOptions = categories.map(cat => 
                `<option value="${cat}" ${currentCategory === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
            
            dropdownElement.innerHTML = `
                <select id="select-modal-${transactionId}" class="category-select" style="padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 12px; cursor: pointer; color: #1f2937; background: white;">
                    ${categoryOptions}
                </select>
                <button onclick="showCategorySaveOptionsModal('${transactionId}', '${currentCategory}')" style="margin-left: 4px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úì</button>
                <button onclick="cancelCategoryChangeModal('${transactionId}', '${currentCategory}')" style="margin-left: 4px; padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úï</button>
            `;
        }

        // Show options for saving category change in modal
        function showCategorySaveOptionsModal(transactionId, oldCategory) {
            const selectElement = document.getElementById(`select-modal-${transactionId}`);
            const newCategory = selectElement.value;
            
            if (newCategory === oldCategory) {
                cancelCategoryChangeModal(transactionId, oldCategory);
                return;
            }

            // Show modal with options
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 15px 0; color: #333;">Update Category</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">How would you like to update the category to "${newCategory}"?</p>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="saveCategoryChangeModal('${transactionId}', '${oldCategory}', 'single'); this.closest('[style*=fixed]').remove();" 
                                style="padding: 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Update this transaction only
                        </button>
                        <button onclick="saveCategoryChangeModal('${transactionId}', '${oldCategory}', 'all'); this.closest('[style*=fixed]').remove();" 
                                style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Update all similar transactions
                        </button>
                        <button onclick="this.closest('[style*=fixed]').remove(); cancelCategoryChangeModal('${transactionId}', '${oldCategory}');" 
                                style="padding: 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Save category change from modal
        async function saveCategoryChangeModal(transactionId, oldCategory, mode = 'single') {
            const selectElement = document.getElementById(`select-modal-${transactionId}`);
            const newCategory = selectElement.value;
            
            if (mode === 'single') {
                await updateSingleTransactionCategory(transactionId, newCategory);
            } else {
                await updateTransactionCategory(transactionId, newCategory);
            }
            
            // Close the modal and reopen it to refresh the list
            const categoryName = document.getElementById('categoryTransactionsTitle').textContent.replace(' Transactions', '');
            closeCategoryTransactionsModal();
            await viewCategoryTransactions(categoryName);
        }

        // Cancel category change in modal
        function cancelCategoryChangeModal(transactionId, currentCategory) {
            const badgeElement = document.getElementById(`category-badge-modal-${transactionId}`);
            const dropdownElement = document.getElementById(`category-dropdown-modal-${transactionId}`);
            
            // Show badge, hide dropdown
            badgeElement.style.display = 'inline';
            dropdownElement.style.display = 'none';
        }

        function closeCategoryTransactionsModal() {
            document.getElementById('categoryTransactionsModal').style.display = 'none';
        }

        // Tab navigation
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activate button
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'rules') {
                loadRules();
            }
        }

        // Load all data
        async function loadData() {
            await loadOverview();
            await loadAccounts();
            await loadRecentTransactions();
            await loadBalanceHistory();
            await loadCategoryBreakdown();
            await loadIncomeCategoryBreakdown();
            await loadRecurringTransactions();
            await loadEssentialExpenses();
        }

        // Recurring transactions
        let currentRecurringMonths = 6;

        async function loadRecurringTransactions(months = currentRecurringMonths) {
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/recurring-transactions?months=${months}`);
                const data = await response.json();
                renderRecurringTransactions(data);
            } catch (error) {
                console.error('Error loading recurring transactions:', error);
                document.getElementById('recurringTransactions').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderRecurringTransactions(data) {
            const container = document.getElementById('recurringTransactions');
            
            if (data.expenses.length === 0 && data.income.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Recurring Transactions</h3>
                        <p>No recurring patterns found for this period</p>
                    </div>
                `;
                return;
            }

            // Calculate totals
            const totalExpenses = data.expenses.reduce((sum, r) => sum + Math.abs(r.averageAmount), 0);
            const totalIncome = data.income.reduce((sum, r) => sum + r.averageAmount, 0);

            let html = '';

            // Recurring Income Section
            if (data.income.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); border-radius: 8px; color: white;">
                            <div style="font-size: 14px; opacity: 0.9;">üí∞ Estimated Monthly Recurring Income</div>
                            <div style="font-size: 28px; font-weight: bold; margin-top: 5px;">‚Ç¨${totalIncome.toFixed(2)}</div>
                        </div>
                        <div class="recurring-grid">
                            ${data.income.map(r => {
                                const escapedCategory = (r.category || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                return `
                                <div class="recurring-card">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px; color: #ffffff;">${escapeHtml(r.name)}</div>
                                            <span class="category-badge" style="cursor: pointer;" onclick="viewCategoryTransactions('${escapedCategory}')">${r.category}</span>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">
                                                +‚Ç¨${r.averageAmount.toFixed(2)}
                                            </div>
                                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">avg</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: rgba(255, 255, 255, 0.7);">
                                        <div>
                                            <div style="font-weight: 500; color: rgba(255, 255, 255, 0.6);">Frequency</div>
                                            <div style="color: #ffffff;">${r.frequency}</div>
                                        </div>
                                        <div>
                                            <div style="font-weight: 500; color: rgba(255, 255, 255, 0.6);">Occurrences</div>
                                            <div style="color: #ffffff;">${r.occurrences}x</div>
                                        </div>
                                    </div>
                                    ${r.nextExpectedDate ? `
                                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.15); font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                                            <span style="font-weight: 500;">Next Expected:</span> <span style="color: #ffffff;">${formatDate(r.nextExpectedDate)}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Recurring Expenses Section
            if (data.expenses.length > 0) {
                html += `
                    <div>
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                            <div style="font-size: 14px; opacity: 0.9;">üí≥ Estimated Monthly Recurring Expenses</div>
                            <div style="font-size: 28px; font-weight: bold; margin-top: 5px;">‚Ç¨${totalExpenses.toFixed(2)}</div>
                        </div>
                        <div class="recurring-grid">
                            ${data.expenses.map(r => {
                                const escapedCategory = (r.category || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                return `
                                <div class="recurring-card">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px; color: #ffffff;">${escapeHtml(r.name)}</div>
                                            <span class="category-badge" style="cursor: pointer;" onclick="viewCategoryTransactions('${escapedCategory}')">${r.category}</span>
                                            ${r.isEssentialExpense ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">üéØ Essential</span>' : ''}
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;">
                                                ‚Ç¨${Math.abs(r.averageAmount).toFixed(2)}
                                            </div>
                                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">avg</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; color: rgba(255, 255, 255, 0.7);">
                                        <div>
                                            <div style="font-weight: 500; color: rgba(255, 255, 255, 0.6);">Frequency</div>
                                            <div style="color: #ffffff;">${r.frequency}</div>
                                        </div>
                                        <div>
                                            <div style="font-weight: 500; color: rgba(255, 255, 255, 0.6);">Occurrences</div>
                                            <div style="color: #ffffff;">${r.occurrences}x</div>
                                        </div>
                                    </div>
                                    ${r.nextExpectedDate ? `
                                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.15); font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                                            <span style="font-weight: 500;">Next Expected:</span> <span style="color: #ffffff;">${formatDate(r.nextExpectedDate)}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function changeRecurringPeriod(months) {
            currentRecurringMonths = months;
            
            // Update button states
            document.querySelectorAll('#overview-tab .section:nth-child(2) .period-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.months) === months);
            });
            
            loadRecurringTransactions(months);
        }

        // Category breakdown
        let currentCategoryDays = 30;
        let categoryChart = null;
        let currentIncomeCategoryDays = 30;
        let incomeCategoryChart = null;

        async function loadCategoryBreakdown(days = currentCategoryDays) {
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/categories?days=${days}`);
                const categories = await response.json();
                
                if (categories.length === 0) {
                    document.getElementById('categoryBreakdown').innerHTML = `
                        <div class="empty-state">
                            <h3>No Spending Data</h3>
                            <p>No expenses found for this period</p>
                        </div>
                    `;
                    return;
                }

                renderCategoryPieChart(categories);
                renderCategoryList(categories);
            } catch (error) {
                console.error('Failed to load category breakdown:', error);
            }
        }

        async function loadIncomeCategoryBreakdown(days = currentIncomeCategoryDays) {
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/income-categories?days=${days}`);
                const categories = await response.json();
                
                if (categories.length === 0) {
                    document.getElementById('incomeCategoryBreakdown').innerHTML = `
                        <div class="empty-state">
                            <h3>No Income Data</h3>
                            <p>No income found for this period</p>
                        </div>
                    `;
                    if (incomeCategoryChart) {
                        incomeCategoryChart.destroy();
                        incomeCategoryChart = null;
                    }
                    return;
                }

                renderIncomeCategoryPieChart(categories);
                renderIncomeCategoryList(categories);
            } catch (error) {
                console.error('Failed to load income category breakdown:', error);
            }
        }

        function renderCategoryPieChart(categories) {
            const canvas = document.getElementById('categoryPieChart');
            const ctx = canvas.getContext('2d');

            // Destroy previous chart if exists
            if (categoryChart) {
                categoryChart.destroy();
            }

            // Generate colors for each category
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471f5', '#fa709a',
                '#ff9a9e', '#fecfef', '#ffdee9', '#fbc2eb',
                '#a18cd1', '#ffecd2', '#fcb69f', '#ff9a9e'
            ];

            const data = {
                labels: categories.map(c => c.category),
                datasets: [{
                    data: categories.map(c => c.total),
                    backgroundColor: colors.slice(0, categories.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };

            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ‚Ç¨${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCategoryList(categories) {
            const total = categories.reduce((sum, cat) => sum + cat.total, 0);
            
            const rows = categories.map(cat => {
                const percentage = ((cat.total / total) * 100).toFixed(1);
                const escapedCategory = cat.category.replace(/'/g, "\\'");
                return `
                    <div onclick="viewCategoryTransactions('${escapedCategory}')" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.08); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(255, 255, 255, 0.1);" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(99, 102, 241, 0.5)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'">
                        <div>
                            <div style="font-weight: 600; color: #ffffff; margin-bottom: 3px;">${cat.category}</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">${cat.count} transactions</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #ef4444; font-size: 18px;">‚Ç¨${cat.total.toFixed(2)}</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">${percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('categoryBreakdown').innerHTML = `
                <div>
                    <h3 style="margin-bottom: 15px; color: #ffffff; font-weight: 600;">Category Breakdown</h3>
                    ${rows}
                    <div style="padding: 15px; background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%); color: white; border-radius: 12px; margin-top: 10px; text-align: center; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">
                        <div style="font-size: 14px; margin-bottom: 5px; opacity: 0.9;">Total Expenses</div>
                        <div style="font-size: 24px; font-weight: 700;">‚Ç¨${total.toFixed(2)}</div>
                    </div>
                </div>
            `;
        }

        function renderIncomeCategoryPieChart(categories) {
            const canvas = document.getElementById('incomeCategoryPieChart');
            const ctx = canvas.getContext('2d');

            // Destroy previous chart if exists
            if (incomeCategoryChart) {
                incomeCategoryChart.destroy();
            }

            // Generate colors for each category (green shades for income)
            const colors = [
                '#10b981', '#34d399', '#6ee7b7', '#059669',
                '#14b8a6', '#2dd4bf', '#5eead4', '#0d9488',
                '#22c55e', '#4ade80', '#86efac', '#16a34a',
                '#84cc16', '#a3e635', '#bef264', '#65a30d',
                '#eab308', '#facc15', '#fde047', '#ca8a04'
            ];

            const data = {
                labels: categories.map(c => c.category),
                datasets: [{
                    data: categories.map(c => c.total),
                    backgroundColor: colors.slice(0, categories.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };

            incomeCategoryChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ‚Ç¨${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderIncomeCategoryList(categories) {
            const total = categories.reduce((sum, cat) => sum + cat.total, 0);
            
            const rows = categories.map(cat => {
                const percentage = ((cat.total / total) * 100).toFixed(1);
                const escapedCategory = cat.category.replace(/'/g, "\\'");
                return `
                    <div onclick="viewCategoryTransactions('${escapedCategory}')" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.08); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(255, 255, 255, 0.1);" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(16, 185, 129, 0.5)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'">
                        <div>
                            <div style="font-weight: 600; color: #ffffff; margin-bottom: 3px;">${cat.category}</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">${cat.count} transactions</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #10b981; font-size: 18px;">‚Ç¨${cat.total.toFixed(2)}</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">${percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('incomeCategoryBreakdown').innerHTML = `
                <div>
                    <h3 style="margin-bottom: 15px; color: #ffffff; font-weight: 600;">Category Breakdown</h3>
                    ${rows}
                    <div style="padding: 15px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px; margin-top: 10px; text-align: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                        <div style="font-size: 14px; margin-bottom: 5px; opacity: 0.9;">Total Income</div>
                        <div style="font-size: 24px; font-weight: 700;">‚Ç¨${total.toFixed(2)}</div>
                    </div>
                </div>
            `;
        }

        function changeCategoryPeriod(days) {
            currentCategoryDays = days;
            
            // Update active button
            document.querySelectorAll('[data-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-days="${days}"]`).classList.add('active');
            
            // Reload data
            loadCategoryBreakdown(days);
        }

        function changeIncomeCategoryPeriod(days) {
            currentIncomeCategoryDays = days;
            
            // Update active button
            document.querySelectorAll('[data-income-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-income-days="${days}"]`).classList.add('active');
            
            // Reload data
            loadIncomeCategoryBreakdown(days);
        }

        // Global custom date range functions
        async function applyGlobalCustomRange() {
            const startDate = document.getElementById('global-start-date').value;
            const endDate = document.getElementById('global-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            // Mark all section period buttons to show custom is active
            document.querySelectorAll('.period-selector .period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            try {
                // Update overview stats with custom date range
                console.log('Fetching overview stats...');
                const overviewResponse = await Auth.fetchWithAuth(`/api/stats/overview?startDate=${startDate}&endDate=${endDate}`);
                if (!overviewResponse.ok) {
                    const errorText = await overviewResponse.text();
                    console.error('Overview stats error:', overviewResponse.status, errorText);
                    throw new Error(`Failed to fetch overview stats: ${overviewResponse.status}`);
                }
                const overviewData = await overviewResponse.json();
                console.log('‚úì Overview stats loaded');
                
                // Update the stat cards
                document.getElementById('totalBalance').textContent = formatCurrency(overviewData.totalBalance);
                document.getElementById('income30').textContent = formatCurrency(overviewData.income30Days);
                document.getElementById('expenses30').textContent = formatCurrency(overviewData.expenses30Days);
                document.getElementById('essentialExpenses30').textContent = formatCurrency(overviewData.essentialExpenses30Days);
                
                const net = overviewData.net30Days;
                const netElement = document.getElementById('net30');
                netElement.textContent = formatCurrency(net);
                netElement.className = 'value ' + (net >= 0 ? 'positive' : 'negative');
                
                // Update spending category breakdown
                console.log('Fetching spending categories...');
                const spendingResponse = await Auth.fetchWithAuth(`/api/stats/categories?startDate=${startDate}&endDate=${endDate}`);
                if (!spendingResponse.ok) {
                    const errorText = await spendingResponse.text();
                    console.error('Spending categories error:', spendingResponse.status, errorText);
                    throw new Error(`Failed to fetch spending categories: ${spendingResponse.status}`);
                }
                const spendingCategories = await spendingResponse.json();
                console.log('‚úì Spending categories loaded');
                if (spendingCategories.length === 0) {
                    document.getElementById('categoryBreakdown').innerHTML = `
                        <div class="empty-state">
                            <h3>No Spending Data</h3>
                            <p>No expenses found for this period</p>
                        </div>
                    `;
                } else {
                    renderCategoryPieChart(spendingCategories);
                    renderCategoryList(spendingCategories);
                }
                
                // Update income category breakdown
                console.log('Fetching income categories...');
                const incomeResponse = await Auth.fetchWithAuth(`/api/stats/income-categories?startDate=${startDate}&endDate=${endDate}`);
                if (!incomeResponse.ok) {
                    const errorText = await incomeResponse.text();
                    console.error('Income categories error:', incomeResponse.status, errorText);
                    throw new Error(`Failed to fetch income categories: ${incomeResponse.status}`);
                }
                const incomeCategories = await incomeResponse.json();
                console.log('‚úì Income categories loaded');
                if (incomeCategories.length === 0) {
                    document.getElementById('incomeCategoryBreakdown').innerHTML = `
                        <div class="empty-state">
                            <h3>No Income Data</h3>
                            <p>No income found for this period</p>
                        </div>
                    `;
                } else {
                    renderIncomeCategoryPieChart(incomeCategories);
                    renderIncomeCategoryList(incomeCategories);
                }
                
                // Update essential expenses
                console.log('Fetching essential expenses...');
                const essentialResponse = await Auth.fetchWithAuth(`/api/stats/essential-expenses?startDate=${startDate}&endDate=${endDate}`);
                if (!essentialResponse.ok) {
                    const errorText = await essentialResponse.text();
                    console.error('Essential expenses error:', essentialResponse.status, errorText);
                    throw new Error(`Failed to fetch essential expenses: ${essentialResponse.status}`);
                }
                const essentialData = await essentialResponse.json();
                console.log('‚úì Essential expenses loaded');
                const essentialContainer = document.getElementById('essentialExpensesSection');
                if (essentialData.count === 0) {
                    essentialContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>No Essential Expenses</h3>
                            <p>Mark expenses as essential in the Transactions tab</p>
                        </div>
                    `;
                } else {
                    // Render essential expenses with consistent styling
                    let html = `
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; color: white;">
                            <div style="font-size: 14px; opacity: 0.9;">üéØ Total Essential Expenses</div>
                            <div style="font-size: 28px; font-weight: bold; margin-top: 5px;">${formatCurrency(essentialData.total)}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">${essentialData.count} transactions</div>
                        </div>
                    `;

                    if (essentialData.byCategory && essentialData.byCategory.length > 0) {
                        html += `
                            <div class="category-grid">
                                ${essentialData.byCategory.map(cat => `
                                    <div onclick="viewEssentialExpensesByCategory('${cat.category.replace(/'/g, "\\'")}')" 
                                         style="cursor: pointer; transition: all 0.3s ease;" 
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';" 
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; font-weight: 500; margin-bottom: 8px;">${cat.category}</div>
                                        <div style="color: #f59e0b; font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(cat.total)}</div>
                                        <div style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">${cat.count} transactions</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }                    essentialContainer.innerHTML = html;
                }
                
                // Update recurring transactions
                console.log('Fetching recurring transactions...');
                const recurringResponse = await Auth.fetchWithAuth(`/api/stats/recurring-transactions?startDate=${startDate}&endDate=${endDate}`);
                if (!recurringResponse.ok) {
                    const errorText = await recurringResponse.text();
                    console.error('Recurring transactions error:', recurringResponse.status, errorText);
                    throw new Error(`Failed to fetch recurring transactions: ${recurringResponse.status}`);
                }
                const recurringData = await recurringResponse.json();
                console.log('‚úì Recurring transactions loaded');
                const recurringContainer = document.getElementById('recurringTransactions');
                if (recurringData.length === 0) {
                    recurringContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>No Recurring Patterns</h3>
                            <p>Not enough transaction data to identify recurring patterns</p>
                        </div>
                    `;
                } else {
                    renderRecurringTransactions(recurringData);
                }
                
                // Update balance history
                console.log('Fetching balance history...');
                const balanceResponse = await Auth.fetchWithAuth(`/api/stats/balance-history?startDate=${startDate}&endDate=${endDate}`);
                if (!balanceResponse.ok) {
                    const errorText = await balanceResponse.text();
                    console.error('Balance history error:', balanceResponse.status, errorText);
                    throw new Error(`Failed to fetch balance history: ${balanceResponse.status}`);
                }
                const balanceData = await balanceResponse.json();
                console.log('‚úì Balance history loaded');
                if (balanceData.length === 0) {
                    document.getElementById('balanceChart').innerHTML = `
                        <div class="empty-state">
                            <h3>No Balance History</h3>
                            <p>No balance snapshots found for this period</p>
                        </div>
                    `;
                } else {
                    renderBalanceChart(balanceData);
                }
                
                console.log('All sections updated with custom date range:', startDate, 'to', endDate);
            } catch (error) {
                console.error('Error applying global custom range:', error);
                alert(`Error updating sections: ${error.message}`);
            }
        }
        
        function clearGlobalCustomRange() {
            // Clear date inputs
            document.getElementById('global-start-date').value = '';
            document.getElementById('global-end-date').value = '';
            
            // Reset all sections to their default periods
            changeCategoryPeriod(30);
            changeIncomeCategoryPeriod(30);
            changeEssentialExpensesPeriod(30);
            changeRecurringPeriod(6);
            changeBalanceHistoryPeriod(1);
            
            console.log('Global custom range cleared, all sections reset to defaults');
        }

        // Legacy custom date range functions (kept for backwards compatibility)
        function toggleCustomDateRange(section) {
            const rangeDiv = document.getElementById(`${section}-custom-range`);
            if (!rangeDiv) return; // Section might not have custom range anymore
            const isVisible = rangeDiv.style.display === 'flex';
            rangeDiv.style.display = isVisible ? 'none' : 'flex';
            
            if (!isVisible) {
                // Set default dates (last 30 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                const startInput = document.getElementById(`${section}-start-date`);
                const endInput = document.getElementById(`${section}-end-date`);
                if (startInput) startInput.valueAsDate = startDate;
                if (endInput) endInput.valueAsDate = endDate;
            }
        }

        async function applyCustomCategoryRange() {
            const startDate = document.getElementById('spending-start-date').value;
            const endDate = document.getElementById('spending-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Mark custom button as active
            document.querySelectorAll('[data-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-days="custom"]').classList.add('active');
            
            // Load data with custom range
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/categories?startDate=${startDate}&endDate=${endDate}`);
                const categories = await response.json();
                
                if (categories.length === 0) {
                    document.getElementById('categoryBreakdown').innerHTML = `
                        <div class="empty-state">
                            <h3>No Spending Data</h3>
                            <p>No expenses found for this period</p>
                        </div>
                    `;
                    return;
                }

                renderCategoryPieChart(categories);
                renderCategoryList(categories);
            } catch (error) {
                console.error('Failed to load category breakdown:', error);
            }
        }

        async function applyCustomIncomeCategoryRange() {
            const startDate = document.getElementById('income-start-date').value;
            const endDate = document.getElementById('income-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Mark custom button as active
            document.querySelectorAll('[data-income-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-income-days="custom"]').classList.add('active');
            
            // Load data with custom range
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/income-categories?startDate=${startDate}&endDate=${endDate}`);
                const categories = await response.json();
                
                if (categories.length === 0) {
                    document.getElementById('incomeCategoryBreakdown').innerHTML = `
                        <div class="empty-state">
                            <h3>No Income Data</h3>
                            <p>No income found for this period</p>
                        </div>
                    `;
                    if (incomeCategoryChart) {
                        incomeCategoryChart.destroy();
                        incomeCategoryChart = null;
                    }
                    return;
                }

                renderIncomeCategoryPieChart(categories);
                renderIncomeCategoryList(categories);
            } catch (error) {
                console.error('Failed to load income category breakdown:', error);
            }
        }

        async function applyCustomRecurringRange() {
            const startDate = document.getElementById('recurring-start-date').value;
            const endDate = document.getElementById('recurring-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Mark custom button as active
            document.querySelectorAll('[data-months]').forEach(btn => {
                btn.classList.remove('active');
            });
            const customBtn = document.querySelector('[data-months="custom"]');
            if (customBtn) customBtn.classList.add('active');
            
            // Load data with custom range
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/recurring-transactions?startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                renderRecurringTransactions(data);
            } catch (error) {
                console.error('Failed to load recurring transactions:', error);
            }
        }

        async function applyCustomBalanceRange() {
            const startDate = document.getElementById('balance-start-date').value;
            const endDate = document.getElementById('balance-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Mark custom button as active
            document.querySelectorAll('#overview-tab .section:nth-child(4) [data-months]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#overview-tab .section:nth-child(4) [data-months="custom"]')?.classList.add('active');
            
            // Load data with custom range
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/balance-history?startDate=${startDate}&endDate=${endDate}`);
                const snapshots = await response.json();
                
                if (snapshots.length === 0) {
                    document.getElementById('balanceHistoryChart').innerHTML = `
                        <div class="empty-state">
                            <h3>No Balance History Yet</h3>
                            <p>Click "Record Snapshot" to start tracking your total balance over time</p>
                        </div>
                    `;
                    document.getElementById('balanceHistoryTable').innerHTML = '';
                    return;
                }

                renderBalanceChart(snapshots);
                renderBalanceTable(snapshots);
            } catch (error) {
                console.error('Failed to load balance history:', error);
            }
        }

        // Essential Expenses functions
        let currentEssentialExpensesDays = 30;

        async function loadEssentialExpenses(days = currentEssentialExpensesDays) {
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/essential-expenses?days=${days}`);
                const data = await response.json();
                
                const container = document.getElementById('essentialExpensesSection');
                
                if (data.count === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Essential Expenses</h3>
                            <p>Mark expenses as essential in the Transactions tab</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; color: white;">
                        <div style="font-size: 14px; opacity: 0.9;">üéØ Total Essential Expenses</div>
                        <div style="font-size: 28px; font-weight: bold; margin-top: 5px;">${formatCurrency(data.total)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">${data.count} transactions</div>
                    </div>
                `;

                if (data.byCategory && data.byCategory.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #ffffff; font-weight: 600;">By Category</h3>
                            <div style="display: grid; gap: 10px;">
                                ${data.byCategory.map(cat => `
                                    <div onclick="viewEssentialExpensesByCategory('${cat.category.replace(/'/g, "\\'")}')"
                                         style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.08); border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                                         onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" 
                                         onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'">
                                        <div>
                                            <div style="font-weight: 500; color: #ffffff;">${cat.category}</div>
                                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">${cat.count} transactions</div>
                                        </div>
                                        <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">${formatCurrency(cat.total)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load essential expenses:', error);
            }
        }

        function changeEssentialExpensesPeriod(days) {
            currentEssentialExpensesDays = days;
            
            document.querySelectorAll('[data-essential-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-essential-days="${days}"]`).classList.add('active');
            
            loadEssentialExpenses(days);
        }

        async function applyCustomEssentialExpensesRange() {
            const startDate = document.getElementById('essential-start-date').value;
            const endDate = document.getElementById('essential-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            document.querySelectorAll('[data-essential-days]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-essential-days="custom"]').classList.add('active');
            
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/essential-expenses?startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                
                const container = document.getElementById('essentialExpensesSection');
                
                if (data.count === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Essential Expenses</h3>
                            <p>No essential expenses found for this period</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; color: white;">
                        <div style="font-size: 14px; opacity: 0.9;">üéØ Total Essential Expenses</div>
                        <div style="font-size: 28px; font-weight: bold; margin-top: 5px;">${formatCurrency(data.total)}</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 3px;">${data.count} transactions</div>
                    </div>
                `;

                if (data.byCategory && data.byCategory.length > 0) {
                    html += `
                        <div class="category-grid">
                            ${data.byCategory.map(cat => `
                                <div onclick="viewEssentialExpensesByCategory('${cat.category.replace(/'/g, "\\'")}')" 
                                     style="cursor: pointer; transition: all 0.3s ease;" 
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)';" 
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; font-weight: 500; margin-bottom: 8px;">${cat.category}</div>
                                    <div style="color: #f59e0b; font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(cat.total)}</div>
                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 12px;">${cat.count} transactions</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load essential expenses:', error);
            }
        }

        // View all essential expense transactions
        async function viewEssentialExpenseTransactions() {
            try {
                // Get all accounts first
                const accountsResponse = await Auth.fetchWithAuth('/api/accounts');
                const accounts = await accountsResponse.json();
                
                // Fetch transactions from all accounts
                const allTransactions = [];
                for (const account of accounts) {
                    try {
                        const txResponse = await Auth.fetchWithAuth(`/api/accounts/${account.id}/transactions?pageSize=1000`);
                        const txData = await txResponse.json();
                        if (txData.transactions && txData.transactions.length > 0) {
                            allTransactions.push(...txData.transactions);
                        }
                    } catch (err) {
                        console.error(`Failed to load transactions for account ${account.id}:`, err);
                    }
                }
                
                // Filter only essential expenses (negative amounts)
                const essentialTransactions = allTransactions.filter(t => t.isEssentialExpense && t.amount < 0);
                
                if (essentialTransactions.length === 0) {
                    alert('No essential expense transactions found');
                    return;
                }
                
                // Display in category modal (reuse existing modal)
                const modal = document.getElementById('categoryTransactionsModal');
                const title = document.getElementById('categoryTransactionsTitle');
                const list = document.getElementById('categoryTransactionsList');
                
                title.textContent = 'üéØ Essential Expense Transactions';
                
                // Sort by date descending
                essentialTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                list.innerHTML = essentialTransactions.map(tx => {
                    const isIncome = tx.amount > 0;
                    const escapedCategory = (tx.category || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const essentialBadge = !isIncome && tx.isEssentialExpense ? `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">üéØ Essential</span>` : '';
                    const essentialToggle = !isIncome ? `<button onclick="toggleEssentialInModal('${tx.id}', ${tx.isEssentialExpense || false}, '${escapeHtml(tx.description || '').replace(/'/g, "\\'")}' )" style="background: ${tx.isEssentialExpense ? '#f59e0b' : '#374151'}; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin-left: 5px;" title="${tx.isEssentialExpense ? 'Remove from essential' : 'Mark as essential'}">${tx.isEssentialExpense ? 'üéØ' : '‚ûïüéØ'}</button>` : '';
                    
                    return `
                        <div style="padding: 15px; margin-bottom: 10px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; transition: all 0.3s ease;" data-transaction-id="${tx.id}" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(147, 51, 234, 0.5)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.15)';">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: #ffffff;">${tx.description || 'No description'}</strong>
                                    <span id="category-badge-modal-${tx.id}">
                                        <span class="category-badge" onclick="showCategoryDropdownModal('${tx.id}', '${escapedCategory}')" style="cursor: pointer; background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-left: 8px; font-weight: 500;">${tx.category}</span>
                                    </span>
                                    <span id="category-dropdown-modal-${tx.id}" style="display: none; margin-left: 5px;"></span>
                                    ${essentialBadge}
                                    ${essentialToggle}
                                </div>
                                <strong style="color: ${tx.amount >= 0 ? '#10b981' : '#ef4444'}; font-size: 16px;">${formatCurrency(tx.amount)}</strong>
                            </div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                                ${formatDate(tx.date)}
                                ${tx.accountName ? `<span style="margin-left: 10px;">‚Ä¢ ${tx.accountName}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Failed to load essential expense transactions:', error);
                alert('Failed to load essential expense transactions');
            }
        }

        // View essential expense transactions filtered by category
        async function viewEssentialExpensesByCategory(category) {
            try {
                // Get all accounts first
                const accountsResponse = await Auth.fetchWithAuth('/api/accounts');
                const accounts = await accountsResponse.json();
                
                // Fetch transactions from all accounts
                const allTransactions = [];
                for (const account of accounts) {
                    try {
                        const txResponse = await Auth.fetchWithAuth(`/api/accounts/${account.id}/transactions?pageSize=1000`);
                        const txData = await txResponse.json();
                        if (txData.transactions && txData.transactions.length > 0) {
                            allTransactions.push(...txData.transactions);
                        }
                    } catch (err) {
                        console.error(`Failed to load transactions for account ${account.id}:`, err);
                    }
                }
                
                // Filter only essential expenses for this category (negative amounts)
                const essentialTransactions = allTransactions.filter(t => 
                    t.isEssentialExpense && t.amount < 0 && t.category === category
                );
                
                if (essentialTransactions.length === 0) {
                    alert(`No essential expense transactions found for category: ${category}`);
                    return;
                }
                
                // Display in category modal (reuse existing modal)
                const modal = document.getElementById('categoryTransactionsModal');
                const title = document.getElementById('categoryTransactionsTitle');
                const list = document.getElementById('categoryTransactionsList');
                
                title.textContent = `üéØ ${category} - Essential Expenses`;
                
                // Sort by date descending
                essentialTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                list.innerHTML = essentialTransactions.map(tx => {
                    const isIncome = tx.amount > 0;
                    const escapedCategory = (tx.category || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const essentialBadge = !isIncome && tx.isEssentialExpense ? `<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">üéØ Essential</span>` : '';
                    const essentialToggle = !isIncome ? `<button onclick="toggleEssentialInModal('${tx.id}', ${tx.isEssentialExpense || false}, '${escapeHtml(tx.description || '').replace(/'/g, "\\'")}' )" style="background: ${tx.isEssentialExpense ? '#f59e0b' : '#374151'}; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin-left: 5px;" title="${tx.isEssentialExpense ? 'Remove from essential' : 'Mark as essential'}">${tx.isEssentialExpense ? 'üéØ' : '‚ûïüéØ'}</button>` : '';
                    
                    return `
                        <div style="padding: 15px; margin-bottom: 10px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; transition: all 0.3s ease;" data-transaction-id="${tx.id}" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(147, 51, 234, 0.5)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.15)';">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: #ffffff;">${tx.description || 'No description'}</strong>
                                    <span id="category-badge-modal-${tx.id}">
                                        <span class="category-badge" onclick="showCategoryDropdownModal('${tx.id}', '${escapedCategory}')" style="cursor: pointer; background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-left: 8px; font-weight: 500;">${tx.category}</span>
                                    </span>
                                    <span id="category-dropdown-modal-${tx.id}" style="display: none; margin-left: 5px;"></span>
                                    ${essentialBadge}
                                    ${essentialToggle}
                                </div>
                                <strong style="color: ${tx.amount >= 0 ? '#10b981' : '#ef4444'}; font-size: 16px;">${formatCurrency(tx.amount)}</strong>
                            </div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                                ${formatDate(tx.date)}
                                ${tx.accountName ? `<span style="margin-left: 10px;">‚Ä¢ ${tx.accountName}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Failed to load essential expense transactions by category:', error);
                alert('Failed to load essential expense transactions');
            }
        }

        // Load balance history
        let currentBalanceHistoryMonths = 1;
        
        async function loadBalanceHistory(months = currentBalanceHistoryMonths) {
            try {
                const response = await Auth.fetchWithAuth(`/api/stats/balance-history?months=${months}`);
                const snapshots = await response.json();
                
                if (snapshots.length === 0) {
                    document.getElementById('balanceHistoryChart').innerHTML = `
                        <div class="empty-state">
                            <h3>No Balance History Yet</h3>
                            <p>Click "Record Snapshot" to start tracking your total balance over time</p>
                        </div>
                    `;
                    document.getElementById('balanceHistoryTable').innerHTML = '';
                    return;
                }

                // Render chart
                renderBalanceChart(snapshots);
                
                // Render table
                renderBalanceTable(snapshots);
            } catch (error) {
                console.error('Failed to load balance history:', error);
            }
        }

        function renderBalanceChart(snapshots) {
            const maxBalance = Math.max(...snapshots.map(s => s.totalBalance));
            const minBalance = Math.min(...snapshots.map(s => s.totalBalance));
            const range = maxBalance - minBalance || 1;

            const bars = snapshots.map(snapshot => {
                const height = ((snapshot.totalBalance - minBalance) / range) * 100;
                const date = new Date(snapshot.timestamp);
                const label = date.toLocaleDateString('en-IE', { month: 'short', day: 'numeric' });
                
                return `
                    <div class="chart-bar" style="height: ${height}%" title="${formatCurrency(snapshot.totalBalance)} on ${date.toLocaleDateString('en-IE')}">
                        <div class="chart-bar-value">${formatCurrency(snapshot.totalBalance)}</div>
                        <div class="chart-bar-label">${label}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('balanceHistoryChart').innerHTML = `
                <div class="balance-chart">
                    <div class="chart-bars">
                        ${bars}
                    </div>
                </div>
            `;
        }

        function renderBalanceTable(snapshots) {
            const rows = snapshots.map((snapshot, index) => {
                const date = new Date(snapshot.timestamp);
                const dateStr = date.toLocaleDateString('en-IE', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let changeHtml = '';
                if (index > 0) {
                    const prevBalance = snapshots[index - 1].totalBalance;
                    const change = snapshot.totalBalance - prevBalance;
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    const arrow = change >= 0 ? '‚Üë' : '‚Üì';
                    changeHtml = `
                        <span class="balance-change ${changeClass}">
                            ${arrow} ${formatCurrency(Math.abs(change))}
                        </span>
                    `;
                }

                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td><strong>${formatCurrency(snapshot.totalBalance)}</strong></td>
                        <td>${changeHtml}</td>
                    </tr>
                `;
            }).reverse().join('');

            document.getElementById('balanceHistoryTable').innerHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Total Balance</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        async function createBalanceSnapshot() {
            try {
                const response = await Auth.fetchWithAuth('/api/stats/snapshot', { method: 'POST' });
                const result = await response.json();
                
                alert(`Balance snapshot recorded: ${formatCurrency(result.totalBalance)}`);
                await loadBalanceHistory();
            } catch (error) {
                console.error('Failed to create snapshot:', error);
                alert('Failed to record balance snapshot');
            }
        }

        function changeBalanceHistoryPeriod(months) {
            currentBalanceHistoryMonths = months;
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-months="${months}"]`).classList.add('active');
            
            // Reload history with new period
            loadBalanceHistory(months);
        }

        // Check for callback
        const urlParams = new URLSearchParams(window.location.search);
        const requisitionId = urlParams.get('ref');
        if (requisitionId) {
            // Sync the requisition
            Auth.fetchWithAuth(`/api/banks/sync/${requisitionId}`, { method: 'POST' })
                .then(() => {
                    alert('Account synced successfully!');
                    window.history.replaceState({}, document.title, '/');
                    loadData();
                })
                .catch(error => {
                    console.error('Failed to sync:', error);
                });
        } else {
            loadData();
        }

        // Re-categorize all transactions
        async function recategorizeAllTransactions() {
            if (!confirm('This will automatically categorize all transactions based on their descriptions and merchant names. Continue?')) {
                return;
            }

            try {
                const response = await Auth.fetchWithAuth('/api/accounts/recategorize-all', { method: 'POST' });
                const data = await response.json();
                
                alert(`${data.message}\n\nTotal transactions: ${data.total}\nUpdated: ${data.updated}`);
                await loadData();
            } catch (error) {
                console.error('Failed to re-categorize:', error);
                alert('Failed to re-categorize transactions');
            }
        }

        // Refresh data every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);

        // ==================== CATEGORIZATION RULES ====================
        
        async function loadRules() {
            try {
                const response = await Auth.fetchWithAuth('/api/categorizationrules');
                const rules = await response.json();
                
                const container = document.getElementById('rulesList');
                
                if (rules.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No Rules Yet</h3>
                            <p>Create your first rule to automatically categorize transactions</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = rules.map(rule => `
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #14b8a6; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(147, 51, 234, 0.5)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderLeftColor='#14b8a6'; this.style.borderColor='rgba(255, 255, 255, 0.15)'; this.style.borderLeft='4px solid #14b8a6';">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <span style="font-size: 18px; font-weight: 600; color: #ffffff;">
                                        ${escapeHtml(rule.pattern)}
                                    </span>
                                    <span style="font-size: 16px; color: rgba(255, 255, 255, 0.5);">‚Üí</span>
                                    <span class="badge" style="background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%); color: white; padding: 6px 14px; border-radius: 8px; font-size: 14px; font-weight: 500; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                                        ${escapeHtml(rule.category)}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 20px; font-size: 13px; color: rgba(255, 255, 255, 0.6); flex-wrap: wrap;">
                                    <span title="Match type">
                                        ${rule.isRegex ? 'üîß Regex' : 'üìù Text'}
                                    </span>
                                    <span title="Case sensitivity">
                                        ${rule.caseSensitive ? 'üî† Case-sensitive' : 'üî° Case-insensitive'}
                                    </span>
                                    <span title="Priority (higher = checked first)">
                                        ‚öñÔ∏è Priority: ${rule.priority}
                                    </span>
                                    <span title="Transaction type filter">
                                        ${rule.transactionType === 'Positive' ? 'üí∞ Income only' : rule.transactionType === 'Negative' ? 'üí∏ Expenses only' : 'üîÑ Any'}
                                    </span>
                                    ${rule.markAsEssential ? '<span title="Marks as essential expense" style="color: #f59e0b;">üéØ Essential</span>' : ''}
                                    ${rule.timesUsed > 0 ? `<span title="Times used" style="color: #10b981;">‚úì Used ${rule.timesUsed}x</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn btn-secondary" onclick="editRule('${rule.id}')" style="padding: 8px 16px;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn" onclick="deleteRule('${rule.id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        ${rule.lastUsedAt ? `<div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">Last used: ${formatDate(rule.lastUsedAt)}</div>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load rules:', error);
            }
        }

        function openAddRuleModal() {
            document.getElementById('ruleModalTitle').textContent = 'Add Categorization Rule';
            document.getElementById('ruleId').value = '';
            document.getElementById('rulePattern').value = '';
            document.getElementById('ruleCategory').value = 'Bills';
            document.getElementById('ruleIsRegex').checked = false;
            document.getElementById('ruleCaseSensitive').checked = false;
            document.getElementById('rulePriority').value = '0';
            document.getElementById('ruleTransactionType').value = 'Any';
            
            const modal = document.getElementById('ruleModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        async function editRule(ruleId) {
            try {
                const response = await Auth.fetchWithAuth('/api/categorizationrules');
                const rules = await response.json();
                const rule = rules.find(r => r.id === ruleId);
                
                if (!rule) {
                    alert('Rule not found');
                    return;
                }
                
                document.getElementById('ruleModalTitle').textContent = 'Edit Categorization Rule';
                document.getElementById('ruleId').value = rule.id;
                document.getElementById('rulePattern').value = rule.pattern;
                document.getElementById('ruleCategory').value = rule.category;
                document.getElementById('ruleIsRegex').checked = rule.isRegex;
                document.getElementById('ruleCaseSensitive').checked = rule.caseSensitive;
                document.getElementById('rulePriority').value = rule.priority;
                document.getElementById('ruleMarkEssential').checked = rule.markAsEssential || false;
                document.getElementById('ruleTransactionType').value = rule.transactionType || 'Any';
                
                const modal = document.getElementById('ruleModal');
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('active'), 10);
            } catch (error) {
                console.error('Failed to load rule:', error);
                alert('Failed to load rule details');
            }
        }

        function closeRuleModal() {
            const modal = document.getElementById('ruleModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function saveRule() {
            const ruleId = document.getElementById('ruleId').value;
            const pattern = document.getElementById('rulePattern').value.trim();
            const category = document.getElementById('ruleCategory').value;
            const isRegex = document.getElementById('ruleIsRegex').checked;
            const caseSensitive = document.getElementById('ruleCaseSensitive').checked;
            const priority = parseInt(document.getElementById('rulePriority').value) || 0;
            const markAsEssential = document.getElementById('ruleMarkEssential').checked;
            const transactionType = document.getElementById('ruleTransactionType').value;
            
            if (!pattern) {
                alert('Please enter a pattern');
                return;
            }
            
            try {
                let response;
                if (ruleId) {
                    // Update existing rule
                    response = await Auth.fetchWithAuth(`/api/categorizationrules/${ruleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pattern, category, isRegex, caseSensitive, priority, markAsEssential, transactionType })
                    });
                } else {
                    // Create new rule
                    response = await Auth.fetchWithAuth('/api/categorizationrules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pattern, category, isRegex, caseSensitive, priority, markAsEssential, transactionType })
                    });
                }
                
                if (response.ok) {
                    closeRuleModal();
                    await loadRules();
                    alert(ruleId ? 'Rule updated successfully!' : 'Rule created successfully!');
                } else {
                    const data = await response.json();
                    alert(`Failed to save rule: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to save rule:', error);
                alert('Failed to save rule. Please try again.');
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule?')) {
                return;
            }
            
            try {
                const response = await Auth.fetchWithAuth(`/api/categorizationrules/${ruleId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadRules();
                    alert('Rule deleted successfully!');
                } else {
                    alert('Failed to delete rule');
                }
            } catch (error) {
                console.error('Failed to delete rule:', error);
                alert('Failed to delete rule. Please try again.');
            }
        }

        async function applyRulesToExisting() {
            if (!confirm('This will apply your rules to ALL existing transactions, overriding their current categories. Continue?')) {
                return;
            }
            
            try {
                const response = await Auth.fetchWithAuth('/api/categorizationrules/apply', {
                    method: 'POST'
                });
                
                const data = await response.json();
                alert(`‚úÖ ${data.message}\n\n${data.count} transactions were categorized using your rules.`);
                await loadData();
            } catch (error) {
                console.error('Failed to apply rules:', error);
                alert('Failed to apply rules. Please try again.');
            }
        }

        // Initialize user info display
        async function initUserInfo() {
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = Auth.getUserDisplayName();
            }

            // Check if user is admin and show admin link
            try {
                const response = await Auth.fetchWithAuth('/api/auth/me');
                if (response.ok) {
                    const user = await response.json();
                    if (user.roles && user.roles.includes('Admin')) {
                        const adminLink = document.getElementById('adminLink');
                        if (adminLink) {
                            adminLink.style.display = 'flex';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to check admin status:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initUserInfo();
        });
    </script>
</body>
</html>

